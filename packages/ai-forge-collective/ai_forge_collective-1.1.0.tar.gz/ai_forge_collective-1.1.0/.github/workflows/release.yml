name: Release

on:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          version: 'latest'

      - name: Set up Python
        run: uv python install 3.12

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install dependencies
        run: mise run sync

      - name: Run quality checks
        run: mise run check && mise run test

      - name: Build Python package
        run: mise run build

      - name: Get version
        id: version
        run: echo "version=$(uv run python -c 'import ai_forge; print(ai_forge.__version__)')" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ steps.version.outputs.version }}
          path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.build.outputs.version }}
          path: dist/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: AI Forge ${{ github.ref_name }}
          body: |
            ## Changes in ${{ github.ref_name }}

            This release includes the built Python package for AI Forge - a universal starter template for Claude Code.

            ### Installation
            ```bash
            # Install from PyPI (recommended)
            uv tool install ai-forge-collective==${{ needs.build.outputs.version }}

            # Or install from GitHub release
            pip install https://github.com/ddlaws0n/ai-forge/releases/download/${{ github.ref_name }}/ai_forge_collective-${{ needs.build.outputs.version }}-py3-none-any.whl
            ```

            ### Usage
            ```bash
            # Initialize a new project with universal starter template
            ai-forge init

            # Optional: Force overwrite existing files
            ai-forge init --force
            ```

            ### MVP Features
            - Universal starter template that works for any project type
            - Generates essential Claude Code configuration files
            - Security-first design with safe defaults
            - Zero to productive in 60 seconds
          files: |
            dist/*
          draft: false
          prerelease: false

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.build.outputs.version }}
          path: dist/

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
