"""
Vulnerability model for representing security issues.
"""

from dataclasses import dataclass
from enum import Enum, auto
from pathlib import Path
from typing import Optional, List, Dict, Any


class SeverityLevel(Enum):
    """Severity levels for vulnerabilities."""
    LOW = auto()
    MEDIUM = auto()
    HIGH = auto()
    CRITICAL = auto()


class VulnerabilityType(Enum):
    """Types of vulnerabilities that can be detected."""
    COMMAND_INJECTION = auto()
    ENVIRONMENT = auto()
    PATH_TRAVERSAL = auto()
    VARIABLE_EXPANSION = auto()
    PARAMETER_EXPANSION = auto()
    PRIVILEGE = auto()
    SHELLCHECK = auto()
    OTHER = auto()
    UNQUOTED_VARIABLE = auto()
    COMMAND_SUBSTITUTION = auto()
    UNQUOTED_COMMAND_SUBSTITUTION = auto()
    ARRAY_INDEX_ATTACK = auto()
    SYNTAX_ERROR = auto()
    GLOB_EXPANSION = auto()

class Description(Enum):
    """Desciprtions for the found vulnerabilities."""
    MISSING_PATH = (
        "PATH variable is missing. For security, it's recommended to explicitly declare a safe PATH at the beginning of the script."
    )

    PARAMETER_EXPANSION_0 = (
        "Be careful when expanding parameter 0. Race condition is a possible attack."
    )

    VARIABLE_EXPANSION = (
        "Unquoted variables in may lead to command injection or word splitting/globbing"
    )

    COMMAND_SUBSTITUTION = (
        "Command substitution with unvalidated input may lead to command injection"
    )

    UNQUOTED_COMMAND_SUBSTITUTION = (
        "Unquoted command substitution may lead to word splitting/globbing"
    )

    EVAL_SOURCE = (
        "eval/source command with unvalidated input is extremely dangerous"
    )

    COMMAND_INJECTION = (
        "Executin variable with unvalidated input may lead to command injection"
    )
    
    ARRAY_INDEX_ATTACK = (
        "Array index with untrusted input can lead to code execution."
    )

    SYNTAX_ERROR = (
        "Syntax error."
    )

    GLOB_EXPANSION = (
        "Unqouted parameters may lead to expansion."
    )

class Recommendation(Enum):
    """Recommendations for the found vulnerabilities."""
    VARIABLE_EXPANSION = (
        "Always quote variables when using them in commands"
    )

    COMMAND_SUBSTITUTION = (
        "Validate and sanitize all input before using it in command substituon"
    )

    UNQUOTED_COMMAND_SUBSTITUTION = (
        "Quote command substitution to prevent word splitting/globbing"
    )

    EVAL_SOURCE = (
        "Avoid using eval/source with unvalidated input. Consider alternative approaches."
    )

    COMMAND_INJECTION = (
        "Validate and sanitize all input before using it in command execution"
    )
    
    ARRAY_INDEX_ATTACK = (
        "Validate and sanitize array indices, especially when they come from user input."
    )

    SYNTAX_ERROR = (
        "Handle syntax errors before proceeding to vulnerability analysis."
    )

    GLOB_EXPANSION = (
        "Quote parameters to prevent glob expansion."
    )

    def __str__(self) -> str:
        return self.value

@dataclass
class Vulnerability:
    """
    Represents a security vulnerability found in a Bash script.
    """
    
    # Basic information
    vulnerability_type: VulnerabilityType
    severity: SeverityLevel
    description: str
    
    # Location information
    file_path: Optional[Path] = None
    line_number: int = -1
    column: Optional[int] = None
    line_content: Optional[str] = None
    
    # Additional information
    code_snippet: Optional[str] = None
    recommendation: Optional[str] = None
    cve_id: Optional[str] = None
    references: Optional[List[str]] = None
    metadata: Optional[Dict[str, Any]] = None
    
    def __post_init__(self):
        """Perform post-initialization tasks."""
        
        # tree_sitter starts indexing from 0
        if self.line_number != -1:
            self.line_number += 1
            self.column += 1 

        if self.line_content is None:
            try:
                with open(self.file_path, 'r') as f:
                    lines = f.readlines()
                    if 0 <= self.line_number - 1 < len(lines):
                        self.line_content = lines[self.line_number - 1].rstrip().expandtabs(8)
            except:
                pass
    
    def __str__(self):
        return f"""
        Vulnerability [
            type = {self.vulnerability_type},
            severity = {self.severity},
            description = {self.description},
            file_path = {self.file_path},
            line_number = {self.line_number},
            column = {self.column},
            line_content = {self.line_content}
        ]
        """