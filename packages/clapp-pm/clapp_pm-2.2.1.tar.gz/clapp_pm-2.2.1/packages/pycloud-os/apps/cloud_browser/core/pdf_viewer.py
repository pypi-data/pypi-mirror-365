"""
Cloud Browser PDF G√∂r√ºnt√ºleyici
PDF dosyalarƒ±nƒ± g√∂r√ºnt√ºleme desteƒüi
"""

import os
from pathlib import Path
from typing import Optional

try:
    from PyQt6.QtWidgets import *
    from PyQt6.QtCore import *
    from PyQt6.QtGui import *
    from PyQt6.QtWebEngineWidgets import *
    from PyQt6.QtWebEngineCore import *
    from PyQt6.QtPrintSupport import QPrinter, QPrintDialog
    WEBENGINE_AVAILABLE = True
except ImportError:
    try:
        from PyQt6.QtWidgets import *
        from PyQt6.QtCore import *
        from PyQt6.QtGui import *
        from PyQt6.QtPrintSupport import QPrinter, QPrintDialog
        WEBENGINE_AVAILABLE = False
    except ImportError:
        raise ImportError("PyQt6 is required for Cloud Browser")

class PDFViewer(QWidget):
    """
    PDF g√∂r√ºnt√ºleyici widget'ƒ±
    """
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.current_pdf_path = None
        self.current_page = 1
        self.total_pages = 1
        self.zoom_factor = 1.0
        
        self.init_ui()
    
    def init_ui(self):
        """UI'yƒ± ba≈ülat"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # PDF toolbar
        self.create_pdf_toolbar()
        layout.addWidget(self.pdf_toolbar)
        
        # PDF g√∂r√ºnt√ºleme alanƒ±
        if WEBENGINE_AVAILABLE:
            # WebEngine ile PDF g√∂r√ºnt√ºleme
            self.pdf_view = QWebEngineView()
            self.pdf_view.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
            self.pdf_view.customContextMenuRequested.connect(self.show_pdf_context_menu)
        else:
            # Basit metin g√∂r√ºnt√ºleme
            self.pdf_view = QTextEdit()
            self.pdf_view.setReadOnly(True)
            self.pdf_view.setHtml("""
                <h2>PDF G√∂r√ºnt√ºleyici</h2>
                <p>WebEngine mevcut deƒüil. PDF dosyalarƒ± g√∂r√ºnt√ºlenemiyor.</p>
                <p>PDF desteƒüi i√ßin PyQt6-WebEngine gereklidir:</p>
                <code>pip install PyQt6-WebEngine</code>
            """)
        
        layout.addWidget(self.pdf_view)
        
        # Status bar
        self.status_label = QLabel("PDF y√ºklenmedi")
        layout.addWidget(self.status_label)
    
    def create_pdf_toolbar(self):
        """PDF toolbar olu≈ütur"""
        self.pdf_toolbar = QToolBar()
        self.pdf_toolbar.setToolButtonStyle(Qt.ToolButtonStyle.ToolButtonTextBesideIcon)
        
        # Dosya a√ß
        open_action = QAction("üìÇ A√ß", self)
        open_action.setToolTip("PDF dosyasƒ± a√ß")
        open_action.triggered.connect(self.open_pdf_file)
        self.pdf_toolbar.addAction(open_action)
        
        self.pdf_toolbar.addSeparator()
        
        # Sayfa navigasyonu
        self.prev_page_action = QAction("‚¨ÖÔ∏è √ñnceki", self)
        self.prev_page_action.setToolTip("√ñnceki sayfa")
        self.prev_page_action.triggered.connect(self.prev_page)
        self.prev_page_action.setEnabled(False)
        self.pdf_toolbar.addAction(self.prev_page_action)
        
        # Sayfa numarasƒ±
        self.page_label = QLabel("Sayfa: 0 / 0")
        self.pdf_toolbar.addWidget(self.page_label)
        
        self.next_page_action = QAction("‚û°Ô∏è Sonraki", self)
        self.next_page_action.setToolTip("Sonraki sayfa")
        self.next_page_action.triggered.connect(self.next_page)
        self.next_page_action.setEnabled(False)
        self.pdf_toolbar.addAction(self.next_page_action)
        
        self.pdf_toolbar.addSeparator()
        
        # Zoom kontrolleri
        zoom_out_action = QAction("üîç-", self)
        zoom_out_action.setToolTip("Uzakla≈ütƒ±r")
        zoom_out_action.triggered.connect(self.zoom_out)
        self.pdf_toolbar.addAction(zoom_out_action)
        
        self.zoom_label = QLabel("100%")
        self.zoom_label.setMinimumWidth(50)
        self.pdf_toolbar.addWidget(self.zoom_label)
        
        zoom_in_action = QAction("üîç+", self)
        zoom_in_action.setToolTip("Yakƒ±nla≈ütƒ±r")
        zoom_in_action.triggered.connect(self.zoom_in)
        self.pdf_toolbar.addAction(zoom_in_action)
        
        zoom_fit_action = QAction("üìÑ Sƒ±ƒüdƒ±r", self)
        zoom_fit_action.setToolTip("Sayfaya sƒ±ƒüdƒ±r")
        zoom_fit_action.triggered.connect(self.zoom_fit)
        self.pdf_toolbar.addAction(zoom_fit_action)
        
        self.pdf_toolbar.addSeparator()
        
        # Yazdƒ±r
        print_action = QAction("üñ®Ô∏è Yazdƒ±r", self)
        print_action.setToolTip("PDF'i yazdƒ±r")
        print_action.triggered.connect(self.print_pdf)
        self.pdf_toolbar.addAction(print_action)
        
        # Stil uygula
        self.pdf_toolbar.setStyleSheet("""
            QToolBar {
                background-color: #f8f9fa;
                border: none;
                border-bottom: 1px solid #dee2e6;
                padding: 4px;
            }
            QToolBar QAction {
                padding: 6px 12px;
                margin: 2px;
                border-radius: 4px;
            }
            QToolBar QAction:hover {
                background-color: #e9ecef;
            }
            QLabel {
                padding: 4px 8px;
                color: #6c757d;
            }
        """)
    
    def load_pdf(self, file_path: str):
        """PDF dosyasƒ± y√ºkle"""
        if not os.path.exists(file_path):
            self.show_error("Dosya bulunamadƒ±", f"PDF dosyasƒ± bulunamadƒ±: {file_path}")
            return False
        
        if not file_path.lower().endswith('.pdf'):
            self.show_error("Ge√ßersiz dosya", "Bu dosya bir PDF deƒüil.")
            return False
        
        try:
            self.current_pdf_path = file_path
            
            if WEBENGINE_AVAILABLE:
                # WebEngine ile PDF y√ºkle
                file_url = QUrl.fromLocalFile(os.path.abspath(file_path))
                self.pdf_view.setUrl(file_url)
                
                # PDF y√ºkleme tamamlandƒ±ƒüƒ±nda
                self.pdf_view.loadFinished.connect(self.pdf_loaded)
            else:
                # Basit metin g√∂sterimi
                self.pdf_view.setHtml(f"""
                    <h2>PDF Dosyasƒ±</h2>
                    <p><b>Dosya:</b> {os.path.basename(file_path)}</p>
                    <p><b>Yol:</b> {file_path}</p>
                    <p><b>Boyut:</b> {self.format_file_size(os.path.getsize(file_path))}</p>
                    <br>
                    <p>WebEngine mevcut olmadƒ±ƒüƒ± i√ßin PDF i√ßeriƒüi g√∂r√ºnt√ºlenemiyor.</p>
                    <p>PDF desteƒüi i√ßin PyQt6-WebEngine gereklidir.</p>
                """)
            
            # UI g√ºncelle
            self.update_ui()
            return True
            
        except Exception as e:
            self.show_error("PDF Y√ºkleme Hatasƒ±", f"PDF y√ºklenirken hata olu≈ütu: {e}")
            return False
    
    def pdf_loaded(self, success):
        """PDF y√ºkleme tamamlandƒ±ƒüƒ±nda"""
        if success:
            self.status_label.setText(f"PDF y√ºklendi: {os.path.basename(self.current_pdf_path)}")
            # TODO: Sayfa sayƒ±sƒ±nƒ± al (WebEngine API'si gerekli)
            self.total_pages = 1  # Placeholder
            self.current_page = 1
            self.update_page_info()
        else:
            self.show_error("PDF Y√ºkleme Hatasƒ±", "PDF dosyasƒ± y√ºklenemedi.")
    
    def open_pdf_file(self):
        """PDF dosyasƒ± se√ß ve a√ß"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "PDF Dosyasƒ± A√ß",
            "",
            "PDF Dosyalarƒ± (*.pdf);;T√ºm Dosyalar (*.*)"
        )
        
        if file_path:
            self.load_pdf(file_path)
    
    def prev_page(self):
        """√ñnceki sayfa"""
        if self.current_page > 1:
            self.current_page -= 1
            self.update_page_info()
            # TODO: WebEngine'de sayfa deƒüi≈ütirme implementasyonu
    
    def next_page(self):
        """Sonraki sayfa"""
        if self.current_page < self.total_pages:
            self.current_page += 1
            self.update_page_info()
            # TODO: WebEngine'de sayfa deƒüi≈ütirme implementasyonu
    
    def zoom_in(self):
        """Yakƒ±nla≈ütƒ±r"""
        self.zoom_factor = min(self.zoom_factor * 1.2, 5.0)
        self.apply_zoom()
    
    def zoom_out(self):
        """Uzakla≈ütƒ±r"""
        self.zoom_factor = max(self.zoom_factor / 1.2, 0.2)
        self.apply_zoom()
    
    def zoom_fit(self):
        """Sayfaya sƒ±ƒüdƒ±r"""
        self.zoom_factor = 1.0
        self.apply_zoom()
    
    def apply_zoom(self):
        """Zoom uygula"""
        if WEBENGINE_AVAILABLE and hasattr(self.pdf_view, 'setZoomFactor'):
            self.pdf_view.setZoomFactor(self.zoom_factor)
        
        # Zoom label g√ºncelle
        zoom_percent = int(self.zoom_factor * 100)
        self.zoom_label.setText(f"{zoom_percent}%")
    
    def print_pdf(self):
        """PDF'i yazdƒ±r"""
        if not self.current_pdf_path:
            self.show_error("Hata", "Yazdƒ±rƒ±lacak PDF dosyasƒ± yok.")
            return
        
        if WEBENGINE_AVAILABLE:
            # WebEngine print dialog
            printer = QPrinter()
            print_dialog = QPrintDialog(printer, self)
            
            if print_dialog.exec() == QDialog.DialogCode.Accepted:
                # TODO: WebEngine print implementasyonu
                QMessageBox.information(self, "Yazdƒ±rma", "Yazdƒ±rma √∂zelliƒüi hen√ºz implementasyonda...")
        else:
            QMessageBox.information(self, "Yazdƒ±rma", "Yazdƒ±rma i√ßin WebEngine gereklidir.")
    
    def show_pdf_context_menu(self, position):
        """PDF context men√º"""
        if not WEBENGINE_AVAILABLE:
            return
        
        menu = QMenu(self)
        
        # Kopyala
        copy_action = menu.addAction("üìã Kopyala")
        copy_action.triggered.connect(self.copy_selection)
        
        # Se√ß
        select_all_action = menu.addAction("üîò T√ºm√ºn√º Se√ß")
        select_all_action.triggered.connect(self.select_all)
        
        menu.addSeparator()
        
        # Zoom
        zoom_in_action = menu.addAction("üîç+ Yakƒ±nla≈ütƒ±r")
        zoom_in_action.triggered.connect(self.zoom_in)
        
        zoom_out_action = menu.addAction("üîç- Uzakla≈ütƒ±r")
        zoom_out_action.triggered.connect(self.zoom_out)
        
        zoom_fit_action = menu.addAction("üìÑ Sƒ±ƒüdƒ±r")
        zoom_fit_action.triggered.connect(self.zoom_fit)
        
        menu.addSeparator()
        
        # Yazdƒ±r
        print_action = menu.addAction("üñ®Ô∏è Yazdƒ±r")
        print_action.triggered.connect(self.print_pdf)
        
        menu.exec(self.pdf_view.mapToGlobal(position))
    
    def copy_selection(self):
        """Se√ßili metni kopyala"""
        if WEBENGINE_AVAILABLE and hasattr(self.pdf_view, 'page'):
            # TODO: WebEngine selection copy implementasyonu
            pass
    
    def select_all(self):
        """T√ºm√ºn√º se√ß"""
        if WEBENGINE_AVAILABLE and hasattr(self.pdf_view, 'page'):
            # TODO: WebEngine select all implementasyonu
            pass
    
    def update_ui(self):
        """UI'yƒ± g√ºncelle"""
        has_pdf = self.current_pdf_path is not None
        
        # Sayfa navigasyon butonlarƒ±
        self.prev_page_action.setEnabled(has_pdf and self.current_page > 1)
        self.next_page_action.setEnabled(has_pdf and self.current_page < self.total_pages)
        
        # Sayfa bilgisi
        if has_pdf:
            self.update_page_info()
        else:
            self.page_label.setText("Sayfa: 0 / 0")
    
    def update_page_info(self):
        """Sayfa bilgisini g√ºncelle"""
        self.page_label.setText(f"Sayfa: {self.current_page} / {self.total_pages}")
        
        # Navigasyon butonlarƒ±
        self.prev_page_action.setEnabled(self.current_page > 1)
        self.next_page_action.setEnabled(self.current_page < self.total_pages)
    
    def show_error(self, title: str, message: str):
        """Hata mesajƒ± g√∂ster"""
        QMessageBox.critical(self, title, message)
        self.status_label.setText(f"Hata: {message}")
    
    def format_file_size(self, size_bytes: int) -> str:
        """Dosya boyutunu formatla"""
        if size_bytes == 0:
            return "0 B"
        
        size_names = ["B", "KB", "MB", "GB"]
        i = 0
        while size_bytes >= 1024 and i < len(size_names) - 1:
            size_bytes /= 1024.0
            i += 1
        
        return f"{size_bytes:.1f} {size_names[i]}"

class PDFTab(QWidget):
    """
    PDF sekmesi i√ßin √∂zel widget
    """
    
    def __init__(self, pdf_path: str, parent=None):
        super().__init__(parent)
        self.pdf_path = pdf_path
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        
        # PDF viewer
        self.pdf_viewer = PDFViewer(self)
        layout.addWidget(self.pdf_viewer)
        
        # PDF'i y√ºkle
        self.pdf_viewer.load_pdf(pdf_path)
    
    def get_title(self) -> str:
        """Sekme ba≈ülƒ±ƒüƒ±nƒ± al"""
        if self.pdf_path:
            return f"üìÑ {os.path.basename(self.pdf_path)}"
        return "üìÑ PDF"
    
    def get_url(self) -> str:
        """URL'yi al"""
        if self.pdf_path:
            return f"file://{self.pdf_path}"
        return "about:blank"

def is_pdf_url(url: str) -> bool:
    """URL PDF dosyasƒ± mƒ± kontrol et"""
    if not url:
        return False
    
    # URL'den dosya uzantƒ±sƒ±nƒ± al
    if url.lower().endswith('.pdf'):
        return True
    
    # MIME type kontrol√º (gelecekte implementasyon)
    # TODO: HTTP response header'larƒ±ndan MIME type kontrol√º
    
    return False

def create_pdf_tab(url: str, parent=None) -> Optional[PDFTab]:
    """PDF sekmesi olu≈ütur"""
    if not is_pdf_url(url):
        return None
    
    # file:// URL'sini dosya yoluna √ßevir
    if url.startswith('file://'):
        file_path = url[7:]  # file:// kƒ±smƒ±nƒ± kaldƒ±r
        if os.path.exists(file_path):
            return PDFTab(file_path, parent)
    
    # HTTP/HTTPS URL'leri i√ßin (gelecekte implementasyon)
    # TODO: PDF dosyasƒ±nƒ± indir ve ge√ßici dosya olarak a√ß
    
    return None 