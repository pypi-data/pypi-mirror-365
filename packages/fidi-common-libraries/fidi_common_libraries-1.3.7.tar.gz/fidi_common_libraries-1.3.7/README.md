# FIDI Common Libraries

Bibliotecas compartilhadas entre os projetos da FIDI, desenvolvidas seguindo as melhores pr√°ticas de desenvolvimento Python.

## üìã Vis√£o Geral

Este projeto fornece um conjunto de bibliotecas reutiliz√°veis para automa√ß√£o, integra√ß√£o AWS, processamento de dados e utilit√°rios comuns utilizados nos projetos da FIDI.

## üöÄ Funcionalidades Principais

- **Data**: Opera√ß√µes de banco de dados multi-SGBD (Oracle via oracledb, PostgreSQL, SQL Server)
- **Utils**: Sistema de logging estruturado para m√∫ltiplos SGBDs
- **Constants**: Constantes de status padronizadas e fun√ß√µes de convers√£o entre diferentes tipos de status
- **AWS**: Clientes padronizados para SQS, SNS, Lambda, S3 com configura√ß√£o centralizada
- **Config**: Gerenciamento de par√¢metros com cache e convers√£o autom√°tica de tipos
- **UI**: Componentes para automa√ß√£o de interfaces gr√°ficas com Pywinauto, incluindo inspetor de elementos

## üì¶ Instala√ß√£o e Configura√ß√£o

### Pr√©-requisitos
- Python 3.9+
- Poetry

### Instala√ß√£o como Biblioteca
```bash
# Instalar via Poetry (recomendado)
poetry add git+https://github.com/your-org/fidi-common-libraries.git

# Ou via pip
pip install git+https://github.com/your-org/fidi-common-libraries.git
```

### Desenvolvimento Local
```bash
# Clone o reposit√≥rio
git clone <repository-url>
cd fidi-common-libraries

# Instale as depend√™ncias
poetry install

# Ative o ambiente virtual
poetry shell
```

### Configura√ß√£o de Desenvolvimento
```bash
# Instale os hooks de pre-commit
poetry run pre-commit install

# Execute os testes
poetry run pytest

# Verifique a cobertura de testes
poetry run pytest --cov=src --cov-report=html
```

## üîß Como Usar

### M√≥dulo Data - Opera√ß√µes de Banco

```python
from fidi_common_libraries.data.db_data import DatabaseConfig, DatabaseQuery, ProcessosRpaInserter, ProcessosRpaUpdater
from datetime import datetime

# Configura√ß√£o do banco
db_config = DatabaseConfig.from_env('RPA_')  # Usa vari√°veis RPA_DB_SERVER, etc.

# Inserir registro
inserter = ProcessosRpaInserter(db_config)
registro_id = inserter.insert(
    ambiente="PRD",
    produto="FIDI-ferias",
    versao="1.0.0",
    chapa="123456",
    statusexecucao="NOVO"
)

# Consulta segura
query = DatabaseQuery(db_config)
results = query.execute_query(
    "SELECT * FROM processosrpa WHERE statusexecucao = :status",
    {"status": "NOVO"}
)
```

### M√≥dulo Config - Gerenciamento de Par√¢metros

```python
from fidi_common_libraries.config.parametros import Parametros

# Inicializar o gerenciador de par√¢metros
params = Parametros(ambiente="HML", produto="FIDI-ferias")

# Obter um par√¢metro
url_api = params.get_parametro("URL_API", default="https://api.exemplo.com")

# Obter par√¢metros por grupo
config_email = params.get_parametros_por_grupo("Email")

# Obter par√¢metros por categorias espec√≠ficas
config_ti = params.get_parametros_por_grupo("TI")  # Configura√ß√µes t√©cnicas
config_negocio = params.get_parametros_por_grupo("Negocio")  # Configura√ß√µes de neg√≥cio
config_produto = params.get_parametros_por_grupo("Produto")  # Configura√ß√µes do produto

# Atualizar um par√¢metro
params.atualizar_parametro("TIMEOUT_API", 30)
```

### M√≥dulo Utils - Logging e Status

```python
from fidi_common_libraries.utils.logger import registrar_log_banco
from fidi_common_libraries.constants.status import HubStatus, DBStatus, LogStatus, convert_status
import pyodbc

# Conex√£o com banco
conn = pyodbc.connect(connection_string)

# Registrar log (detecta automaticamente o tipo de banco)
registrar_log_banco(
    conn=conn,
    ambiente="PRD",
    produto="FIDI-ferias",
    versao="1.0.0",
    nivel="INFO",
    modulo="main",
    processo="processamento",
    acao="inicio",
    lote="LOTE001",
    mensagem="Processo iniciado",
    usuario="sistema",
    status_execucao=LogStatus.SUCESSO,
    hostname="server01",
    ip_origem="192.168.1.100"
)

# Usar constantes de status
status_db = DBStatus.NOVO
status_log = convert_status(status_db, 'db', 'log')
```

### M√≥dulo AWS - Clientes Padronizados

```python
from fidi_common_libraries.aws.common_aws import AWSClientFactory, AWSConfig, create_message_with_metadata

# Configura√ß√£o AWS
config = AWSConfig.from_env()  # Usa vari√°veis AWS_REGION, AWS_ACCESS_KEY_ID, etc.
factory = AWSClientFactory(config)

# Cliente SQS
sqs = factory.get_sqs_client()
message_id = sqs.send_message(
    queue_url="https://sqs.sa-east-1.amazonaws.com/123456789/my-queue",
    message={"data": "test"},
    message_attributes={"Type": {"StringValue": "ProcessData", "DataType": "String"}}
)
```

### M√≥dulo UI - Automa√ß√£o de Interfaces Gr√°ficas

```python
from fidi_common_libraries.ui import RMApplication, ElementFinder, UIInteractions, UIWaits, LocatorService

# Conectar ou iniciar aplica√ß√£o RM
app = RMApplication()
app.connect_or_start()  # Conecta se existir ou inicia nova inst√¢ncia

# Aguardar aplica√ß√£o ficar pronta
app.wait_for_application_ready(timeout=60)

# Obter janela principal ou TOTVS
main_window = app.get_main_window()
totvs_window = app.get_totvs_window()

# Navega√ß√£o autom√°tica no sistema RM
from fidi_common_libraries.ui import RMNavigator, LocatorMode
navigator = RMNavigator(app.app, main_window)
success, button_text = navigator.navigate_to_element(
    {"title": "Encargos", "control_type": "TabItem"},
    {"title": "Contabiliza√ß√£o", "control_type": "Pane"},
    {"title": "Gera√ß√£o dos Encargos", "control_type": "Button"}
)

# Login automatizado no sistema RM
from fidi_common_libraries.ui import RMStartLogin, LocatorService
locator_service = LocatorService("locators.yaml")
login_manager = RMStartLogin(locator_service)
success, rm_app = login_manager.start_and_login("HML", "FIDI-ferias")

# Sele√ß√£o de ambiente no login
from fidi_common_libraries.ui import RMLoginEnvSelector
env_selector = RMLoginEnvSelector(login_window, locator_service)
success, alias = env_selector.select_environment("HML", "FIDI-ferias")

# Conex√£o dupla (win32 + uia) para an√°lise
from fidi_common_libraries.ui import RMDualConnect
connector = RMDualConnect(output_dir="locators_output")
success, info = connector.connect_dual()

# Usar servi√ßo de locators para elementos
locator_service = LocatorService("locators.yaml", mode=LocatorMode.PYWINAUTO)
login_criteria = locator_service.get_non_null_attributes("login_button")

# Encontrar elemento com crit√©rios robustos
finder = ElementFinder()
button = finder.find_element(
    parent=main_window,
    primary_criteria=login_criteria,
    fallback_criteria=[{"auto_id": "btnSave"}]
)

# Interagir com elementos de forma segura
interactions = UIInteractions()
interactions.safe_click(button)

# Aguardar elementos ou condi√ß√µes
waits = UIWaits()
waits.wait_for_element_ready(button, timeout=10)

# Inspe√ß√£o de elementos UI (ferramenta de desenvolvimento)
from fidi_common_libraries.ui.utils.inspector import UIElementInspectorAdvanced
inspector = UIElementInspectorAdvanced()
inspector.connect_to_application(window_title="TOTVS")
inspector.start_assisted_navigation()  # Navega√ß√£o assistida com overlay visual

# Fechar aplica√ß√£o quando terminar
app.close_application()  # Fecha apenas se foi iniciada por n√≥s

# Configura√ß√£o AWS
config = AWSConfig.from_env()  # Usa vari√°veis AWS_REGION, AWS_ACCESS_KEY_ID, etc.
factory = AWSClientFactory(config)

# Cliente SQS
sqs = factory.get_sqs_client()
message_id = sqs.send_message(
    queue_url="https://sqs.sa-east-1.amazonaws.com/123456789/my-queue",
    message={"data": "test"},
    message_attributes={"Type": {"StringValue": "ProcessData", "DataType": "String"}}
)

# Cliente SNS
sns = factory.get_sns_client()
sns.publish_message(
    topic_arn="arn:aws:sns:sa-east-1:123456789:my-topic",
    message=create_message_with_metadata({"event": "process_completed"}),
    subject="Processo Finalizado"
)

# Cliente Lambda
lambda_client = factory.get_lambda_client()
result = lambda_client.invoke_function(
    function_name="my-function",
    payload={"action": "process", "data": "test"}
)

# Cliente S3
s3 = factory.get_s3_client()
s3.upload_file("/path/to/file.txt", "my-bucket", "uploads/file.txt")
```

## üèóÔ∏è Estrutura do Projeto

```
fidi-common-libraries/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ fidi_common_libraries/
‚îÇ       ‚îú‚îÄ‚îÄ aws/          # Utilit√°rios AWS
‚îÇ       ‚îú‚îÄ‚îÄ config/       # Gerenciamento de configura√ß√µes e par√¢metros
‚îÇ       ‚îú‚îÄ‚îÄ constants/    # Constantes e enums compartilhados
‚îÇ       ‚îú‚îÄ‚îÄ data/         # Processamento de dados e acesso a banco
‚îÇ       ‚îú‚îÄ‚îÄ ui/           # Automa√ß√£o de UI
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ core/     # Componentes principais
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ utils/    # Utilit√°rios (inspector, screenshot)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ locators/ # Servi√ßos de locators
‚îÇ       ‚îî‚îÄ‚îÄ utils/        # Utilit√°rios gerais e logging
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/            # Testes unit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ integration/     # Testes de integra√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ e2e/            # Testes end-to-end
‚îú‚îÄ‚îÄ docs/               # Documenta√ß√£o
‚îú‚îÄ‚îÄ scripts/            # Scripts auxiliares
‚îî‚îÄ‚îÄ resources/          # Recursos est√°ticos
```

## üß™ Testes

O projeto mant√©m uma cobertura de testes superior a 85%:

```bash
# Executar todos os testes
poetry run pytest

# Executar com cobertura
poetry run pytest --cov=src --cov-report=term-missing

# Executar apenas testes unit√°rios
poetry run pytest tests/unit/
```

## üìä Qualidade de C√≥digo

Ferramentas utilizadas:
- **Black**: Formata√ß√£o autom√°tica
- **Flake8**: Linting
- **MyPy**: Verifica√ß√£o de tipos
- **Bandit**: An√°lise de seguran√ßa

```bash
# Formata√ß√£o
poetry run black src/ tests/

# Linting
poetry run flake8 src/ tests/

# Verifica√ß√£o de tipos
poetry run mypy src/

# An√°lise de seguran√ßa
poetry run bandit -r src/
```

## üìö Documenta√ß√£o

- [INSTALL.md](INSTALL.md) - Guia completo de instala√ß√£o e uso
- [CHANGELOG.md](CHANGELOG.md) - Hist√≥rico de mudan√ßas
- [STATUS_ATUAL.md](STATUS_ATUAL.md) - Estado atual do projeto
- [docs/UI_MODULE_GUIDE.md](docs/UI_MODULE_GUIDE.md) - Guia completo do m√≥dulo UI
- [docs/UI_INSPECTOR_GUIDE.md](docs/UI_INSPECTOR_GUIDE.md) - Guia do inspetor de elementos UI
- [docs/RM_NAVIGATOR_GUIDE.md](docs/RM_NAVIGATOR_GUIDE.md) - Guia do navegador RM
- [docs/RM_AUTOMATION_GUIDE.md](docs/RM_AUTOMATION_GUIDE.md) - Guia completo de automa√ß√£o RM
- [docs/LOCATOR_SERVICE_GUIDE.md](docs/LOCATOR_SERVICE_GUIDE.md) - Guia do servi√ßo de locators

> **Nota**: A partir da vers√£o 1.2.0, este projeto utiliza apenas a biblioteca `oracledb` para conex√µes Oracle, removendo a depend√™ncia do `cx_Oracle`.
>
> **Nota**: A vers√£o 1.3.0 introduz o m√≥dulo `ui` para automa√ß√£o de interfaces gr√°ficas com Pywinauto.
>
> **Nota**: A vers√£o 1.3.1 adiciona funcionalidades avan√ßadas de inicializa√ß√£o e gerenciamento da aplica√ß√£o RM.
>
> **Nota**: A vers√£o 1.3.2 introduz o LocatorService para gerenciamento de locators via arquivos YAML.
>
> **Nota**: A vers√£o 1.3.3 aprimora o LocatorService com valida√ß√£o robusta e tratamento de valores vazios.
>
> **Nota**: A vers√£o 1.3.4 adiciona modos de retorno parametriz√°veis (STD e PYWINAUTO) ao LocatorService.
>
> **Nota**: A vers√£o 1.3.5 expande o LocatorService com suporte a dimens√µes e c√°lculo de centro dos elementos.
>
> **Nota**: A vers√£o 1.3.6 introduz o RMNavigator para navega√ß√£o autom√°tica no sistema TOTVS RM.
>
> **Nota**: A vers√£o 1.3.7 adiciona classes especializadas para RM: RMStartLogin (login automatizado), RMLoginEnvSelector (sele√ß√£o de ambiente) e RMDualConnect (conex√£o dupla para an√°lise).

## ü§ù Contribui√ß√£o

1. Siga as diretrizes estabelecidas em `.amazonq/rules/`
2. Mantenha a cobertura de testes acima de 85%
3. Execute os pre-commit hooks antes de fazer commit
4. Atualize a documenta√ß√£o conforme necess√°rio

## üìÑ Licen√ßa

Este projeto est√° licenciado sob os termos definidos no arquivo [LICENSE](LICENSE).