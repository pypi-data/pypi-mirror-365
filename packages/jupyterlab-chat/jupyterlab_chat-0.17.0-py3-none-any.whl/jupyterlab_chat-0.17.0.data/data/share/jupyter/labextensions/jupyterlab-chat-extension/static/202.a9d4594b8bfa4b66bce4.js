"use strict";(self.webpackChunkjupyterlab_chat_extension=self.webpackChunkjupyterlab_chat_extension||[]).push([[202],{1202:(e,t,s)=>{s.r(t),s.d(t,{ChatPanel:()=>I,ChatWidgetFactory:()=>T,CommandIDs:()=>C,IActiveCellManagerToken:()=>b,IChatFactory:()=>y,IChatPanel:()=>f,IInputToolbarRegistryFactory:()=>w,ISelectionWatcherToken:()=>M,IWelcomeMessage:()=>v,LabChatContext:()=>l,LabChatModel:()=>c,LabChatModelFactory:()=>W,LabChatPanel:()=>S,WidgetConfig:()=>R,YChat:()=>o,chatFileType:()=>_});var a=s(2616),n=s(8725),i=s(4602),r=s(7262),h=s(8e3);class o extends h.YDocument{constructor(e){super(e),this.version="1.0.0",this._usersObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._users.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._users.get(s),type:"change"})}})),this._changed.emit({userChanges:t})},this._messagesObserver=e=>{const t=e.delta;this._changed.emit({messageChanges:t})},this._attachmentsObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._attachments.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._attachments.get(s),type:"change"})}})),this._changed.emit({attachmentChanges:t})},this._metadataObserver=e=>{const t=new Array;e.changes.keys.forEach(((e,s)=>{switch(e.action){case"add":t.push({key:s,newValue:this._metadata.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:e.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:e.oldValue,newValue:this._metadata.get(s),type:"change"})}})),this._changed.emit({metadataChanges:t})},this._users=this.ydoc.getMap("users"),this._users.observe(this._usersObserver),this._messages=this.ydoc.getArray("messages"),this._messages.observe(this._messagesObserver),this._attachments=this.ydoc.getMap("attachments"),this._attachments.observe(this._attachmentsObserver),this._metadata=this.ydoc.getMap("metadata"),this._metadata.observe(this._metadataObserver)}static create(e){return new o(e)}get id(){return this._metadata.get("id")||""}get users(){return r.JSONExt.deepCopy(this._users.toJSON())}get messages(){return r.JSONExt.deepCopy(this._messages.toJSON())}get attachments(){return r.JSONExt.deepCopy(this._attachments.toJSON())}getSource(){return{users:this._users.toJSON(),messages:this._messages.toJSON(),metadata:this._metadata.toJSON()}}setSource(e){e&&this.transact((()=>{var t,s,a;(null!==(t=e.messages)&&void 0!==t?t:[]).forEach((e=>{this._messages.push([e])}));const n=null!==(s=e.users)&&void 0!==s?s:{};Object.entries(n).forEach((([e,t])=>this._users.set(e,t)));const i=null!==(a=e.metadata)&&void 0!==a?a:{};Object.entries(i).forEach((([e,t])=>this._metadata.set(e,t)))}))}getUser(e){if(e)return this._users.get(e)}setUser(e){this.transact((()=>{"toJSON"in e&&"function"==typeof e.toJSON&&(e=e.toJSON()),this._users.set(e.username,e)}))}getMessage(e){return this._messages.get(e)}addMessage(e){this.transact((()=>{this._messages.push([e])}))}updateMessage(e,t){this.transact((()=>{this._messages.delete(e),this._messages.insert(e,[t])}))}getMessageIndex(e){return this._messages.toArray().findIndex((t=>t.id===e))}deleteMessage(e){this.transact((()=>{this._messages.delete(e)}))}getAttachment(e){return this._attachments.get(e)}setAttachment(e){const t=JSON.stringify(e);let s;for(const[e,a]of this._attachments.entries())if(JSON.stringify(a)===t){s=e;break}const a=s||r.UUID.uuid4();return this.transact((()=>{this._attachments.set(a,e)})),a}}class d{constructor(e){var t;this.username=null!==(t=null==e?void 0:e.username)&&void 0!==t?t:"user undefined",this.name=null==e?void 0:e.name,this.display_name=null==e?void 0:e.display_name,this.color=null==e?void 0:e.color,this.avatar_url=null==e?void 0:e.avatar_url,this.initials=null==e?void 0:e.initials,this.bot=!!(null==e?void 0:e.bot)||!1}get mention_name(){let e=this.display_name||this.name||this.username;return e=e.replace(/ /g,"-"),e}toJSON(){return{...this,mention_name:this.mention_name}}}class c extends a.AbstractChatModel{constructor(e){super(e),this.collaborative=!0,this.onInputChanged=(e,t)=>{if(!e||!this.config.sendTypingNotification)return;const s=this.sharedModel.awareness;null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting),s.setLocalStateField("isWriting",null==t||t),this._timeoutWriting=window.setTimeout((()=>{this._resetWritingStatus()}),1e3)},this.onMessageEditionAdded=(e,t)=>{if(null!==t){const e=(e,s)=>{this.onInputChanged(s,t.id)};t.model.valueChanged.connect(e)}},this.onAwarenessChange=()=>{const e=[],t=this.sharedModel.awareness.getStates();for(const s of t.keys()){const a=t.get(s);if(a&&a.user&&a.user.username!==this.user.username&&void 0!==a.isWriting&&!1!==a.isWriting){const t={user:a.user,messageID:!0===a.isWriting?void 0:a.isWriting};e.push(t)}}this.updateWriters(e)},this._onchange=async(e,t)=>{if(t.messageChanges){const e=t.messageChanges;let s=0;for(const t of e)if(t.retain)s+=t.retain;else if(t.insert){const e=t.insert.map((e=>{const{sender:t,attachments:s,mentions:a,...n}=e,i={...n,sender:this.sharedModel.getUser(t)||{username:"User undefined",mention_name:"User-undefined"}};if(s){const e=[];s.forEach((t=>{const s=this.sharedModel.getAttachment(t);s&&e.push(s)})),e.length&&(i.attachments=e)}const r=(null!=a?a:[]).map((e=>this.sharedModel.getUser(e)||{username:"User undefined",mention_name:"User-undefined"}));return(null==r?void 0:r.length)&&(i.mentions=r),i}));await this.messagesInserted(s,e),s+=e.length}else t.delete&&this.messagesDeleted(s,t.delete)}t.metadataChanges&&t.metadataChanges.forEach((e=>{"id"===e.key&&(this.id=e.newValue)})),t.userChanges&&t.userChanges.forEach((e=>{e.key===this._user.username&&e.newValue&&(this._user=e.newValue)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._ready=new r.PromiseDelegate,this._dirty=!1,this._readOnly=!1,this._disposed=new i.Signal(this),this._contentChanged=new i.Signal(this),this._stateChanged=new i.Signal(this),this._timeoutWriting=null,this._user=new d(e.user);const{widgetConfig:t,sharedModel:s}=e;this._sharedModel=s||o.create(),this.sharedModel.changed.connect(this._onchange,this),this.config=t.config,t.configChanged.connect(((e,t)=>{this.config=t})),this.sharedModel.awareness.on("change",this.onAwarenessChange),this.input.valueChanged.connect(((e,t)=>this.onInputChanged(t))),this.messageEditionAdded.connect(this.onMessageEditionAdded)}get user(){return this._user}get sharedModel(){return this._sharedModel}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get ready(){return this._ready.promise}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get disposed(){return this._disposed}set id(e){super.id=e,e&&this._ready.resolve()}dispose(){this.isDisposed||(super.dispose(),this._sharedModel.dispose(),this._disposed.emit(),i.Signal.clearData(this))}toString(){return JSON.stringify({},null,2)}fromString(e){}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}createChatContext(){return new l({model:this})}async messagesInserted(e,t){return this._ready.promise.then((()=>{super.messagesInserted(e,t)}))}sendMessage(e){var t;this._resetWritingStatus(),null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting);const s={type:"msg",id:r.UUID.uuid4(),body:e.body,time:Date.now()/1e3,sender:this._user.username,raw_time:!0};this.sharedModel.getUser(this._user.username)!==this._user&&this.sharedModel.setUser(this._user);const a=null===(t=this.input.attachments)||void 0===t?void 0:t.map((e=>this.sharedModel.setAttachment(e)));(null==a?void 0:a.length)&&(s.attachments=a),this.input.clearAttachments();const n=this._buildMentionList(this.input.mentions,e.body);n.length&&(s.mentions=n),this.input.clearMentions(),this.sharedModel.addMessage(s)}clearMessages(){}updateMessage(e,t){var s;const a=this.sharedModel.getMessageIndex(e);let n=this.sharedModel.getMessage(a);if(n)n.body=t.body,n.edited=!0;else{const s=t.sender.username;n={type:"msg",id:e||r.UUID.uuid4(),body:t.body,time:t.time||Date.now()/1e3,sender:s,edited:!0}}const i=null===(s=t.attachments)||void 0===s?void 0:s.map((e=>this.sharedModel.setAttachment(e)));(null==i?void 0:i.length)?n.attachments=i:delete n.attachments;const h=this._buildMentionList(t.mentions,t.body);h.length?n.mentions=h:delete n.mentions,this.sharedModel.updateMessage(a,n)}deleteMessage(e){const t=this.sharedModel.getMessageIndex(e),s=this.sharedModel.getMessage(t);s?(s.body="",s.deleted=!0,this.sharedModel.updateMessage(t,s)):console.error("The message to delete does not exist")}_buildMentionList(e,t){if(!e)return[];const s=[];return e.forEach((e=>{if(!e.mention_name)return;const a="@"+e.mention_name;new RegExp(a).exec(t)&&(this.sharedModel.getUser(e.username)!==e&&this.sharedModel.setUser(e),s.push(e.username))})),s}_resetWritingStatus(){const e=this.sharedModel.awareness,t=e.getLocalState();null==t||delete t.isWriting,e.setLocalState(t),this._timeoutWriting=null}}class l extends a.AbstractChatContext{get users(){const e=this._model,t={};for(const s of Object.values(e.sharedModel.users))t[s.username]=new d(s);return e.sharedModel.awareness.getStates().forEach((e=>{if(!("user"in e))return;const s=e.user;if((null==s?void 0:s.username)in t)return;const a=new d(e.user);t[a.username]=a})),Array.from(Object.values(t))}}var g=s(6907),u=s(9346),m=s(3345),p=s.n(m);const _={name:"chat",displayName:"Chat",mimeTypes:["text/json","application/json"],extensions:[".chat"],fileFormat:"text",contentType:"chat",icon:a.chatIcon},y=new r.Token("jupyterlab-chat:IChatFactory"),C={createChat:"jupyterlab-chat:create",openChat:"jupyterlab-chat:open",moveToSide:"jupyterlab-chat:moveToSide",markAsRead:"jupyterlab-chat:markAsRead",focusInput:"jupyterlab-chat:focusInput"},f=new r.Token("jupyterlab-chat:IChatPanel"),b=new r.Token("jupyterlab-chat:IActiveCellManager"),M=new r.Token("jupyterlab-chat:ISelectionWatcher"),w=new r.Token("jupyterlab-chat:IInputToolbarRegistryFactory"),v=new r.Token("jupyterlab-chat:IWelcomeMessage"),x="jp-lab-chat-title-unread";class S extends n.DocumentWidget{constructor(e){super(e),this._unreadChanged=(e,t)=>{t.length?this.title.className.includes(x)||(this.title.className+=` ${x}`):this.title.className=this.title.className.replace(x,"")},this.addClass("jp-lab-chat-main-panel"),this.model.name=this.context.localPath,this.model.unreadChanged.connect(this._unreadChanged)}dispose(){this.model.unreadChanged.disconnect(this._unreadChanged),this.context.dispose(),this.content.dispose(),super.dispose()}get model(){return this.context.model}}class I extends u.SidePanel{constructor(e){super(e),this.updateChatList=async()=>{const e=_.extensions[0];this._contentsManager.get(this._defaultDirectory).then((t=>{const s={};t.content.filter((t=>"file"===t.type&&t.name.endsWith(e))).forEach((t=>{s[g.PathExt.basename(t.name,e)]=t.path})),this._chatNamesChanged.emit(s)})).catch((e=>console.error("Error getting the chat files from drive",e)))},this._chatSelected=e=>{const t=e.target,s=t.value;"-"!==t.options[t.selectedIndex].textContent&&(this._commands.execute(C.openChat,{filepath:s,inSidePanel:!0}),e.target.selectedIndex=0)},this._chatNamesChanged=new i.Signal(this),this.addClass("jp-lab-chat-sidepanel"),this._commands=e.commands,this._contentsManager=e.contentsManager,this._rmRegistry=e.rmRegistry,this._themeManager=e.themeManager,this._defaultDirectory=e.defaultDirectory,this._chatCommandRegistry=e.chatCommandRegistry,this._attachmentOpenerRegistry=e.attachmentOpenerRegistry,this._inputToolbarFactory=e.inputToolbarFactory,this._messageFooterRegistry=e.messageFooterRegistry,this._welcomeMessage=e.welcomeMessage;const t=new u.CommandToolbarButton({commands:this._commands,id:C.createChat,args:{inSidePanel:!0},icon:u.addIcon});t.addClass("jp-lab-chat-add"),this.toolbar.addItem("createChat",t),this._openChat=u.ReactWidget.create(p().createElement(O,{chatNamesChanged:this._chatNamesChanged,handleChange:this._chatSelected.bind(this)})),this._openChat.addClass("jp-lab-chat-open"),this.toolbar.addItem("openChat",this._openChat),this.content.expansionToggled.connect(this._onExpansionToggled,this),this._contentsManager.fileChanged.connect(((e,t)=>{var s,a;"delete"===t.type&&(this.widgets.forEach((e=>{var s;e.path===(null===(s=t.oldValue)||void 0===s?void 0:s.path)&&e.dispose()})),this.updateChatList()),["new","rename"].includes(t.type)&&(null===(a=null===(s=t.newValue)||void 0===s?void 0:s.path)||void 0===a?void 0:a.endsWith(_.extensions[0]))&&this.updateChatList()}))}get defaultDirectory(){return this._defaultDirectory}set defaultDirectory(e){e!==this._defaultDirectory&&(this._defaultDirectory=e,this.updateChatList(),this.widgets.forEach((t=>{t.defaultDirectory=e})))}addChat(e){const t=this.content;for(let e=0;e<this.widgets.length;e++)t.collapse(e);let s;this._inputToolbarFactory&&(s=this._inputToolbarFactory.create());const n=new a.ChatWidget({model:e,rmRegistry:this._rmRegistry,themeManager:this._themeManager,chatCommandRegistry:this._chatCommandRegistry,attachmentOpenerRegistry:this._attachmentOpenerRegistry,inputToolbarRegistry:s,messageFooterRegistry:this._messageFooterRegistry,welcomeMessage:this._welcomeMessage});return this.addWidget(new k({widget:n,commands:this._commands,path:e.name,defaultDirectory:this._defaultDirectory})),n}openIfExists(e){const t=this._getChatIndex(e);return t>-1&&this._expandChat(t),t>-1}onAfterAttach(e){var t;null===(t=this._openChat.renderPromise)||void 0===t||t.then((()=>this.updateChatList()))}_getChatIndex(e){return this.widgets.findIndex((t=>t.path===e))}_expandChat(e){this.widgets[e].isVisible||this.content.expand(e)}_onExpansionToggled(e,t){if(this.widgets[t].isVisible)for(let s=0;s<this.widgets.length;s++)s!==t&&e.collapse(s)}}class k extends u.PanelWithToolbar{constructor(e){var t;super(e),this._unreadChanged=(e,t)=>{this._markAsRead.enabled=t.length>0},this._spinner=new u.Spinner,this.addWidget(e.widget),this.addWidget(this._spinner),this.addClass("jp-lab-chat-section"),this._defaultDirectory=e.defaultDirectory,this._path=e.path,this._updateTitle(),this.toolbar.addClass("jp-lab-chat-toolbar"),this._markAsRead=new u.ToolbarButton({icon:a.readIcon,iconLabel:"Mark chat as read",className:"jp-mod-styled",onClick:()=>this.model.unreadMessages=[]});const s=new u.ToolbarButton({icon:u.launchIcon,iconLabel:"Move the chat to the main area",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),e.commands.execute(C.openChat,{filepath:this._path}),this.dispose()}}),n=new u.ToolbarButton({icon:u.closeIcon,iconLabel:"Close the chat",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),this.dispose()}});this.toolbar.addItem("jupyterlabChat-markRead",this._markAsRead),this.toolbar.addItem("jupyterlabChat-moveMain",s),this.toolbar.addItem("jupyterlabChat-close",n),null===(t=this.model.unreadChanged)||void 0===t||t.connect(this._unreadChanged),this._markAsRead.enabled=this.model.unreadMessages.length>0,e.widget.node.style.height="100%",this.model.ready.then((()=>{this._spinner.dispose()}))}get path(){return this._path}set defaultDirectory(e){this._defaultDirectory=e,this._updateTitle()}get model(){return this.widgets[0].model}dispose(){var e;null===(e=this.model.unreadChanged)||void 0===e||e.disconnect(this._unreadChanged),super.dispose()}_updateTitle(){const e=!this._defaultDirectory||!g.PathExt.relative(this._defaultDirectory,this._path).startsWith(".."),t=new RegExp(`${_.extensions[0]}$`,"g");this.title.label=(e?this._defaultDirectory?g.PathExt.relative(this._defaultDirectory,this._path):this._path:"/"+this._path).replace(t,""),this.title.caption=this._path}}function O({chatNamesChanged:e,handleChange:t}){const[s,a]=(0,m.useState)({});return e.connect(((e,t)=>{a(t)})),p().createElement(u.HTMLSelect,{onChange:t},p().createElement("option",{value:"-"},"Open a chat"),Object.keys(s).map((e=>p().createElement("option",{value:s[e]},e))))}class R{constructor(e){this._configChanged=new i.Signal(this),this._config=e}get config(){return this._config}set config(e){this._config={...this._config,...e},this._configChanged.emit(e)}get configChanged(){return this._configChanged}}class T extends n.ABCWidgetFactory{constructor(e){super(e),this._themeManager=e.themeManager,this._rmRegistry=e.rmRegistry,this._chatCommandRegistry=e.chatCommandRegistry,this._attachmentOpenerRegistry=e.attachmentOpenerRegistry,this._inputToolbarFactory=e.inputToolbarFactory,this._messageFooterRegistry=e.messageFooterRegistry,this._welcomeMessage=e.welcomeMessage}createNewWidget(e){return e.rmRegistry=this._rmRegistry,e.themeManager=this._themeManager,e.chatCommandRegistry=this._chatCommandRegistry,e.attachmentOpenerRegistry=this._attachmentOpenerRegistry,e.messageFooterRegistry=this._messageFooterRegistry,e.welcomeMessage=this._welcomeMessage,this._inputToolbarFactory&&(e.inputToolbarRegistry=this._inputToolbarFactory.create()),new S({context:e,content:new a.ChatWidget(e)})}get contentProviderId(){return"rtc"}set contentProviderId(e){}}class W{constructor(e){var t,s,a;this.collaborative=!0,this._disposed=!1,this._user=e.user,this._widgetConfig=e.widgetConfig,this._commands=e.commands,this._activeCellManager=null!==(t=e.activeCellManager)&&void 0!==t?t:null,this._selectionWatcher=null!==(s=e.selectionWatcher)&&void 0!==s?s:null,this._documentManager=null!==(a=e.documentManager)&&void 0!==a?a:null}get name(){return"chat"}get contentType(){return"chat"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new c({...e,user:this._user,widgetConfig:this._widgetConfig,commands:this._commands,activeCellManager:this._activeCellManager,selectionWatcher:this._selectionWatcher,documentManager:this._documentManager})}}}}]);