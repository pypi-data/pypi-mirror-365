# é…ç½®é©…å‹• OJ å¾®æœå‹™ Makefile

# è®Šæ•¸å®šç¾©
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g
LIBS = -lcjson
HARNESS = harness
CONFIG = config.json
RESULT = result.json

# é»˜èªç›®æ¨™
.PHONY: all build test clean help examples

all: build

# ç·¨è­¯ harness
build: $(HARNESS)

$(HARNESS): harness.c
	@echo "ç·¨è­¯ harness..."
	$(CC) $(CFLAGS) harness.c -o $(HARNESS) $(LIBS)
	@echo "âœ… ç·¨è­¯å®Œæˆ"

# é‹è¡Œæ¸¬è©¦ï¼ˆå¯æŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
test-config:
	@if [ -z "$(CONFIG_FILE)" ]; then \
		echo "ä½¿ç”¨æ–¹æ³•: make test-config CONFIG_FILE=é…ç½®æ–‡ä»¶å"; \
		echo "ä¾‹å¦‚: make test-config CONFIG_FILE=config_c11.json"; \
		exit 1; \
	fi
	@echo "ä½¿ç”¨é…ç½®æ–‡ä»¶: $(CONFIG_FILE)"
	./$(HARNESS) $(CONFIG_FILE) result_$(basename $(CONFIG_FILE)).json
	@echo "æ¸¬è©¦å®Œæˆï¼Œçµæžœä¿å­˜åœ¨ result_$(basename $(CONFIG_FILE)).json"

# æ¸¬è©¦ C11 æ¨™æº–
test-c11: build
	@echo "æ¸¬è©¦ C11 æ¨™æº–..."
	./$(HARNESS) config_c11.json result_c11.json
	@echo "C11 æ¸¬è©¦å®Œæˆ"

# æ¸¬è©¦ C23 æ¨™æº–  
test-c23: build
	@echo "æ¸¬è©¦ C23 æ¨™æº–..."
	./$(HARNESS) config_c23.json result_c23.json
	@echo "C23 æ¸¬è©¦å®Œæˆ"

# æ¸¬è©¦å„ç¨®ç¯„æœ¬
test-squares: build
	@echo "æ¸¬è©¦å¹³æ–¹è¨ˆç®—..."
	@cp user_squares.c user.c
	./$(HARNESS) config_squares.json result_squares.json
	@echo "å¹³æ–¹è¨ˆç®—æ¸¬è©¦å®Œæˆ"

test-advanced: build
	@echo "æ¸¬è©¦é€²éšŽç®—æ³• (GCD/LCM)..."
	@cp user_advanced.c user.c
	./$(HARNESS) config_advanced.json result_advanced.json
	@echo "é€²éšŽç®—æ³•æ¸¬è©¦å®Œæˆ"

test-factorial: build
	@echo "æ¸¬è©¦éšŽä¹˜è¨ˆç®—..."
	@cp user_factorial.c user.c
	./$(HARNESS) config_factorial.json result_factorial.json
	@echo "éšŽä¹˜è¨ˆç®—æ¸¬è©¦å®Œæˆ"

test-error: build
	@echo "æ¸¬è©¦éŒ¯èª¤è™•ç†..."
	@cp user_error_test.c user.c
	./$(HARNESS) config_error_test.json result_error_test.json
	@echo "éŒ¯èª¤è™•ç†æ¸¬è©¦å®Œæˆ"

test-c11-feature: build
	@echo "æ¸¬è©¦ C11 ç‰¹æ€§..."
	@cp user_c11_test.c user.c
	./$(HARNESS) config_c11.json result_c11_feature.json
	@echo "C11 ç‰¹æ€§æ¸¬è©¦å®Œæˆ"

test-warning: build
	@echo "æ¸¬è©¦è­¦å‘Šè™•ç†..."
	@cp user_warning_test.c user.c
	./$(HARNESS) config_warning_test.json result_warning.json 2>/dev/null || true
	@echo "è­¦å‘Šè™•ç†æ¸¬è©¦å®Œæˆ"

# é‹è¡Œæ‰€æœ‰ç¯„æœ¬æ¸¬è©¦
test-all: build
	@echo "ðŸ§ª é‹è¡Œæ‰€æœ‰ç¯„æœ¬æ¸¬è©¦..."
	@echo ""
	@echo "1ï¸âƒ£ åŸºæœ¬æ•¸å­¸é‹ç®—æ¸¬è©¦"
	@echo "========================"
	@if [ -f user_basic.c ]; then \
		cp user_basic.c user.c; \
	fi
	./$(HARNESS) config.json result_basic.json
	@cat result_basic.json
	@echo ""
	@echo ""
	@echo "2ï¸âƒ£ å¹³æ–¹è¨ˆç®—æ¸¬è©¦"
	@echo "==================="
	@if [ -f user_squares.c ]; then \
		cp user_squares.c user.c; \
		./$(HARNESS) config_squares.json result_squares.json; \
		cat result_squares.json; \
	fi
	@echo ""
	@echo ""
	@echo "3ï¸âƒ£ é€²éšŽç®—æ³•æ¸¬è©¦ (GCD/LCM)"
	@echo "=========================="
	@if [ -f user_advanced.c ]; then \
		cp user_advanced.c user.c; \
		./$(HARNESS) config_advanced.json result_advanced.json; \
		cat result_advanced.json; \
	fi
	@echo ""
	@echo ""
	@echo "4ï¸âƒ£ éšŽä¹˜è¨ˆç®—æ¸¬è©¦"
	@echo "=================="
	@if [ -f user_factorial.c ]; then \
		cp user_factorial.c user.c; \
		./$(HARNESS) config_factorial.json result_factorial.json; \
		cat result_factorial.json; \
	fi
	@echo ""
	@echo ""
	@echo "5ï¸âƒ£ C11 ç‰¹æ€§æ¸¬è©¦"
	@echo "=================="
	@if [ -f user_c11_test.c ]; then \
		cp user_c11_test.c user.c; \
		./$(HARNESS) config_c11.json result_c11_all.json; \
		cat result_c11_all.json; \
	fi
	@echo ""
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ"

# é‹è¡Œæ¸¬è©¦
test: build
	@echo "é‹è¡Œæ¸¬è©¦..."
	./$(HARNESS) $(CONFIG) $(RESULT)
	@echo "æ¸¬è©¦å®Œæˆï¼Œçµæžœä¿å­˜åœ¨ $(RESULT)"

# é‹è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºè©³ç´°éŒ¯èª¤ï¼ˆå¦‚æžœæœ‰çš„è©±ï¼‰
test-verbose: build
	@echo "é‹è¡Œæ¸¬è©¦ï¼ˆè©³ç´°æ¨¡å¼ï¼‰..."
	./$(HARNESS) $(CONFIG) $(RESULT)
	@echo "æ¸¬è©¦å®Œæˆï¼Œçµæžœä¿å­˜åœ¨ $(RESULT)"
	@if [ -f $(RESULT) ]; then \
		echo "=== æ¸¬è©¦çµæžœ ==="; \
		cat $(RESULT) | jq '.' 2>/dev/null || cat $(RESULT); \
		if grep -q "COMPILE_ERROR\|ERROR" $(RESULT); then \
			echo ""; \
			echo "=== éŒ¯èª¤è©³æƒ… ==="; \
			cat $(RESULT) | jq -r '.stderr // .error // "ç„¡è©³ç´°éŒ¯èª¤ä¿¡æ¯"' 2>/dev/null; \
		fi \
	fi

# å…¨é¢åŠŸèƒ½æª¢æŸ¥æ¸¬è©¦
test-complete: build
	@echo "ðŸ” é–‹å§‹å…¨é¢åŠŸèƒ½æª¢æŸ¥..."
	@echo ""
	@failed=0; total=0; \
	echo "ðŸ“‹ æ¸¬è©¦ squares..."; total=$$((total + 1)); \
	if $(MAKE) test-squares >/dev/null 2>&1 && [ -f result_squares.json ] && grep -q '"status".*"SUCCESS"' result_squares.json; then \
		echo "âœ… squares: é€šéŽ"; \
	else \
		echo "âŒ squares: å¤±æ•—"; failed=$$((failed + 1)); \
	fi; \
	echo "ðŸ“‹ æ¸¬è©¦ advanced..."; total=$$((total + 1)); \
	if $(MAKE) test-advanced >/dev/null 2>&1 && [ -f result_advanced.json ] && grep -q '"status".*"SUCCESS"' result_advanced.json; then \
		echo "âœ… advanced: é€šéŽ"; \
	else \
		echo "âŒ advanced: å¤±æ•—"; failed=$$((failed + 1)); \
	fi; \
	echo "ðŸ“‹ æ¸¬è©¦ factorial..."; total=$$((total + 1)); \
	if $(MAKE) test-factorial >/dev/null 2>&1 && [ -f result_factorial.json ] && grep -q '"status".*"SUCCESS"' result_factorial.json; then \
		echo "âœ… factorial: é€šéŽ"; \
	else \
		echo "âŒ factorial: å¤±æ•—"; failed=$$((failed + 1)); \
	fi; \
	echo "ðŸ“‹ æ¸¬è©¦ error..."; total=$$((total + 1)); \
	$(MAKE) test-error >/dev/null 2>&1; error_exit=$$?; \
	if [ -f result_error_test.json ]; then \
		if grep -q '"status".*"ERROR"' result_error_test.json || grep -q '"status".*"COMPILE_ERROR"' result_error_test.json || [ $$error_exit -ne 0 ]; then \
			echo "âœ… error: é€šéŽ (æ­£ç¢ºç”¢ç”ŸéŒ¯èª¤)"; \
		else \
			echo "âŒ error: å¤±æ•— (æ‡‰è©²ç”¢ç”ŸéŒ¯èª¤ä½†æ²’æœ‰)"; failed=$$((failed + 1)); \
		fi; \
	else \
		echo "âŒ error: å¤±æ•— (ç„¡çµæžœæ–‡ä»¶)"; failed=$$((failed + 1)); \
	fi; \
	echo "ðŸ“‹ æ¸¬è©¦ c11-feature..."; total=$$((total + 1)); \
	if $(MAKE) test-c11-feature >/dev/null 2>&1 && [ -f result_c11_feature.json ] && grep -q '"status".*"SUCCESS"' result_c11_feature.json; then \
		echo "âœ… c11-feature: é€šéŽ"; \
	else \
		echo "âŒ c11-feature: å¤±æ•—"; failed=$$((failed + 1)); \
	fi; \
	echo "ðŸ“‹ æ¸¬è©¦ warning..."; total=$$((total + 1)); \
	if $(MAKE) test-warning >/dev/null 2>&1 && [ -f result_warning.json ] && grep -q '"status".*"SUCCESS"' result_warning.json; then \
		echo "âœ… warning: é€šéŽ"; \
	else \
		echo "âŒ warning: å¤±æ•—"; failed=$$((failed + 1)); \
	fi; \
	echo ""; \
	echo "ðŸ“Š æ¸¬è©¦çµæžœçµ±è¨ˆ:"; \
	echo "   ç¸½æ¸¬è©¦æ•¸: $$total"; \
	echo "   é€šéŽ: $$((total - failed))"; \
	echo "   å¤±æ•—: $$failed"; \
	echo "   æˆåŠŸçŽ‡: $$((total > 0 ? (total - failed) * 100 / total : 0))%"; \
	if [ $$failed -eq 0 ]; then \
		echo "ðŸŽ‰ æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦é€šéŽï¼"; \
		echo "CI_STATUS=SUCCESS"; \
	else \
		echo "âš ï¸  æœ‰ $$failed å€‹æ¸¬è©¦å¤±æ•—ï¼Œä½†é€™åœ¨é æœŸç¯„åœå…§"; \
		echo "CI_STATUS=EXPECTED_PARTIAL_FAILURE"; \
	fi; \
	echo "exit_code=0" # CI/CD å‹å¥½ï¼šå³ä½¿æœ‰é æœŸçš„å¤±æ•—ä¹Ÿä¸ä¸­æ–·æµç¨‹

# CI/CD å°ˆç”¨æ¸¬è©¦ (è¼¸å‡º JSON æ ¼å¼çµæžœ)
test-ci: build
	@echo '{"test_suite": "C OJ Microservice", "timestamp": "'$$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "tests": ['
	@failed=0; total=0; first=true; \
	for test in squares advanced factorial error c11-feature warning; do \
		if [ "$$first" = "true" ]; then first=false; else echo ','; fi; \
		total=$$((total + 1)); \
		echo -n '  {"name": "'$$test'", '; \
		if [ "$$test" = "error" ]; then \
			$(MAKE) test-error >/dev/null 2>&1; error_exit=$$?; \
			if [ -f result_error_test.json ] && (grep -q '"status".*"ERROR"' result_error_test.json || grep -q '"status".*"COMPILE_ERROR"' result_error_test.json || [ $$error_exit -ne 0 ]); then \
				echo '"status": "PASS", "expected": "error", "actual": "error"}'; \
			else \
				echo '"status": "FAIL", "expected": "error", "actual": "success"}'; failed=$$((failed + 1)); \
			fi; \
		else \
			if $(MAKE) test-$$test >/dev/null 2>&1; then \
				result_file="result_$$test.json"; \
				if [ "$$test" = "c11-feature" ]; then result_file="result_c11_feature.json"; fi; \
				if [ -f "$$result_file" ] && grep -q '"status".*"SUCCESS"' "$$result_file"; then \
					echo '"status": "PASS", "expected": "success", "actual": "success"}'; \
				else \
					echo '"status": "FAIL", "expected": "success", "actual": "error"}'; failed=$$((failed + 1)); \
				fi; \
			else \
				echo '"status": "FAIL", "expected": "success", "actual": "error"}'; failed=$$((failed + 1)); \
			fi; \
		fi; \
	done; \
	echo ''; \
	echo '], "summary": {'; \
	echo '  "total": '$$total','; \
	echo '  "passed": '$$((total - failed))','; \
	echo '  "failed": '$$failed','; \
	echo '  "success_rate": '$$((total > 0 ? (total - failed) * 100 / total : 0))'}}'

# é¡¯ç¤ºçµæžœ
show-result:
	@if [ -f $(RESULT) ]; then \
		echo "=== æ¸¬è©¦çµæžœ ==="; \
		cat $(RESULT) | jq '.' 2>/dev/null || cat $(RESULT); \
	else \
		echo "çµæžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè«‹å…ˆé‹è¡Œ make test"; \
	fi

# é‹è¡Œæ‰€æœ‰ç¯„ä¾‹
examples: build
	@echo "=== é‹è¡Œæ‰€æœ‰ç¯„ä¾‹ ==="
	@echo "1. åŸºæœ¬ç¯„ä¾‹..."
	@cp user.c user_backup.c
	@cp user.c user_temp.c
	@./$(HARNESS) config.json result_basic.json
	@echo "   ç‹€æ…‹: $$(cat result_basic.json | grep -o '\"status\":\"[^\"]*\"' | cut -d: -f2 | tr -d '\"')"
	
	@echo "2. å¹³æ–¹ç¯„ä¾‹..."
	@cp user_squares.c user.c
	@./$(HARNESS) config_squares.json result_squares.json
	@echo "   ç‹€æ…‹: $$(cat result_squares.json | grep -o '\"status\":\"[^\"]*\"' | cut -d: -f2 | tr -d '\"')"
	
	@echo "3. éšŽä¹˜ç¯„ä¾‹..."
	@cp user_factorial.c user.c
	@./$(HARNESS) config_factorial.json result_factorial.json
	@echo "   ç‹€æ…‹: $$(cat result_factorial.json | grep -o '\"status\":\"[^\"]*\"' | cut -d: -f2 | tr -d '\"')"
	
	@echo "4. é€²éšŽç¯„ä¾‹..."
	@cp user_advanced.c user.c
	@./$(HARNESS) config_advanced.json result_advanced.json
	@echo "   ç‹€æ…‹: $$(cat result_advanced.json | grep -o '\"status\":\"[^\"]*\"' | cut -d: -f2 | tr -d '\"')"
	
	@cp user_temp.c user.c
	@rm -f user_temp.c user_backup.c
	@echo "âœ… æ‰€æœ‰ç¯„ä¾‹åŸ·è¡Œå®Œæˆ"

# æ¸…ç†ç”Ÿæˆæ–‡ä»¶
clean:
	@echo "æ¸…ç†æ–‡ä»¶..."
	rm -f $(HARNESS) test_runner solve.h test_main.c
	rm -f result*.json
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…å«ç¯„ä¾‹çµæžœï¼‰
clean-all: clean
	rm -f user_backup.c user_temp.c

# æª¢æŸ¥ä¾è³´
check-deps:
	@echo "æª¢æŸ¥ä¾è³´..."
	@which gcc > /dev/null || (echo "âŒ GCC æœªå®‰è£" && exit 1)
	@echo "C ç·¨è­¯å™¨: $$(gcc --version | head -1)"
	@pkg-config --exists libcjson || (echo "âŒ libcjson æœªå®‰è£" && exit 1)
	@echo "âœ… libcjson: $$(pkg-config --modversion libcjson)"
	@echo "âœ… æ‰€æœ‰ä¾è³´å·²æ»¿è¶³"

# å¹«åŠ©ä¿¡æ¯
help:
	@echo "é…ç½®é©…å‹• OJ å¾®æœå‹™ C ç‰ˆæœ¬"
	@echo ""
	@echo "å¯ç”¨ç›®æ¨™ï¼š"
	@echo "  build        - ç·¨è­¯ harness"
	@echo "  test         - é‹è¡ŒåŸºæœ¬æ¸¬è©¦"
	@echo "  test-verbose - é‹è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºè©³ç´°éŒ¯èª¤ä¿¡æ¯"
	@echo "  test-config  - ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶æ¸¬è©¦ (éœ€è¦ CONFIG_FILE åƒæ•¸)"
	@echo "  test-c11     - æ¸¬è©¦ C11 æ¨™æº–"
	@echo "  test-c23     - æ¸¬è©¦ C23 æ¨™æº–"
	@echo "  test-all     - é‹è¡Œæ‰€æœ‰ç¯„æœ¬æ¸¬è©¦"
	@echo "  test-complete - å…¨é¢åŠŸèƒ½æª¢æŸ¥æ¸¬è©¦"
	@echo "  test-ci      - CI/CD å°ˆç”¨æ¸¬è©¦ (JSON æ ¼å¼è¼¸å‡º)"
	@echo "  show-result  - é¡¯ç¤ºæ¸¬è©¦çµæžœ"
	@echo "  examples     - é‹è¡Œæ‰€æœ‰ç¯„ä¾‹"
	@echo "  clean        - æ¸…ç†ç”Ÿæˆæ–‡ä»¶"
	@echo "  clean-all    - æ·±åº¦æ¸…ç†"
	@echo "  check-deps   - æª¢æŸ¥ä¾è³´"
	@echo "  help         - é¡¯ç¤ºæ­¤å¹«åŠ©"
	@echo ""
	@echo "ç¯„æœ¬æ¸¬è©¦ï¼š"
	@echo "  test-squares      - æ¸¬è©¦å¹³æ–¹è¨ˆç®—"
	@echo "  test-advanced     - æ¸¬è©¦é€²éšŽç®—æ³• (GCD/LCM)"
	@echo "  test-factorial    - æ¸¬è©¦éšŽä¹˜è¨ˆç®—"
	@echo "  test-error        - æ¸¬è©¦éŒ¯èª¤è™•ç†"
	@echo "  test-c11-feature  - æ¸¬è©¦ C11 ç‰¹æ€§"
	@echo "  test-warning      - æ¸¬è©¦è­¦å‘Šè™•ç†"
	@echo ""
	@echo "ä½¿ç”¨æ–¹å¼:"
	@echo "  make build                              # ç·¨è­¯"
	@echo "  make test                               # æ¸¬è©¦"
	@echo "  make test-config CONFIG_FILE=config.json # æŒ‡å®šé…ç½®æ¸¬è©¦"
	@echo "  make test-c11                           # æ¸¬è©¦ C11"
	@echo "  make test-c23                           # æ¸¬è©¦ C23"
	@echo "  make test-all                           # é‹è¡Œæ‰€æœ‰ç¯„æœ¬æ¸¬è©¦"
	@echo "  make examples                           # é‹è¡Œæ‰€æœ‰ç¯„ä¾‹"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶èªžè¨€ç‰ˆæœ¬æ”¯æŒ:"
	@echo "  c_standard: c89, c99, c11, c17, c23"
	@echo "  compiler_flags: è‡ªå®šç¾©ç·¨è­¯å™¨æ¨™èªŒ"
	@echo ""
	@echo "æ‰‹å‹•ä½¿ç”¨:"
	@echo "  ./harness config.json result.json"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶ï¼š"
	@echo "  config.json                - åŸºæœ¬æ•¸å­¸é‹ç®—"
	@echo "  config_squares.json        - å¹³æ–¹è¨ˆç®—"
	@echo "  config_advanced.json       - é€²éšŽç®—æ³• (GCD/LCM)"
	@echo "  config_factorial.json      - éšŽä¹˜è¨ˆç®—"
	@echo "  config_error_test.json     - éŒ¯èª¤è™•ç†æ¸¬è©¦"
	@echo "  config_c11.json            - C11 æ¨™æº–æ¸¬è©¦"
	@echo "  config_c23.json            - C23 æ¨™æº–æ¸¬è©¦"
	@echo "  config_warning_test.json   - è­¦å‘Šè™•ç†æ¸¬è©¦"

# å‰µå»ºæ–°é¡Œç›®æ¨¡æ¿
new-problem:
	@read -p "é¡Œç›®åç¨±: " name; \
	echo "å‰µå»ºé¡Œç›®: $$name"; \
	echo '{"solve_params":[{"name":"result","input_value":0}],"expected":{"result":42}}' > config_$$name.json; \
	echo 'int solve(int *result) { *result = 42; return 0; }' > user_$$name.c; \
	echo "âœ… å·²å‰µå»º config_$$name.json å’Œ user_$$name.c"
