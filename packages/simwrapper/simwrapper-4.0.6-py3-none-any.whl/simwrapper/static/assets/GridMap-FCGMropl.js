import{d as F,n as N,r as H,g as b,R as D,h as V,M as B,C as U,V as I,S as w}from"./index-SKCiK1zC.js";import{G as W}from"./lil-gui.esm-D2cLj-mk.js";import{d as Y}from"./index-DNDUvpFH.js";import{Y as L}from"./index-WYdOAFlo.js";import{c as $}from"./index-Cy4QFrIo.js";import{a as X}from"./avro-Dd9UqmeZ.js";import{H as q,u as Z}from"./HTTPFileSystem-BuB8fZgO.js";import{h as E,g as J}from"./ColorsAndWidths-C-Lh42fR.js";import{C as P}from"./Coords-Com0YmOE.js";import{B as K}from"./BackgroundMapOnTop-BYgkcgTO.js";import{D as Q}from"./DashboardDataManager-DmbdSxPe.js";import{C as tt}from"./CollapsiblePanel-COXFOJS3.js";import{D as et}from"./DrawingTool-DkPs1xTR.js";import{Z as it}from"./ZoomButtons-Dje-VE6e.js";import{G as st,u as at,U as ot,_ as O,D as lt,S as nt}from"./set-rtl-text-plugin-DzNy9J29.js";import{C as rt}from"./column-layer-Dlolqq4D.js";import"./fxp-DXsl1rlp.js";import"./color-DZRtpOAM.js";import"./cubehelix-Bg3rkAQA.js";import"./Set3-Dyl9Llxj.js";import"./index-_doEQLKC.js";import"./rainbow-Dz4seJAz.js";import"./RoadNetworkLoader.worker-CZuyU4Ze.js";import"./group-DobYzF2-.js";import"./geojson-layer-By_hfVqo.js";import"./text-layer-DB5OKgrd.js";import"./path-layer-D9CUlC4w.js";import"./cut-by-mercator-bounds-BNp6eabq.js";import"./solid-polygon-layer-CTv0ZA23.js";const ht=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mt=new Float32Array([-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1]),ct=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]),ut=new Float32Array([0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]),dt={POSITION:{size:3,value:new Float32Array(mt)},NORMAL:{size:3,value:new Float32Array(ct)},TEXCOORD_0:{size:2,value:new Float32Array(ut)}};class ft extends st{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{id:i=at("cube-geometry")}=t;super({...t,id:i,indices:{size:1,value:new Uint16Array(ht)},attributes:{...dt,...t.attributes}})}}const gt={cellSize:{type:"number",min:0,value:1e3},offset:{type:"array",value:[1,1]}};class M extends rt{getGeometry(t){return new ft}draw({uniforms:t}){const{elevationScale:i,extruded:a,offset:o,coverage:m,cellSize:h,angle:c,radiusUnits:d}=this.props;this.state.model.setUniforms(t).setUniforms({radius:h/2,radiusUnits:ot[d],angle:c,offset:o,extruded:a,coverage:m,elevationScale:i,edgeDistance:1,isWireframe:!1}).draw()}}O(M,"layerName","GridCellLayer");O(M,"defaultProps",gt);const A=6,pt=F({name:"TimeSliderV2",props:{range:{type:Array,required:!0},allTimes:[]},data:()=>({state:{componentWidth:0,dragStartX:0,dragType:0,isDragging:!1,isSetupComplete:!1,leftPosition:0,rightPosition:1,datasetRange:[0,86400],labels:["",""],animationElapsedTime:0,startTime:0,timeFilter:[0,3599],animator:null,timeLabels:[0,1],currentTime:0},id:"id-"+Math.floor(1e12*Math.random()),resizer:null,ANIMATE_SPEED:5,isAnimating:!1}),computed:{fullDatasetTimeSpan(){return this.state.datasetRange[1]-this.state.datasetRange[0]+this.allTimes[0]},extentLeftToRight(){return this.state.rightPosition-this.state.leftPosition},hasNonZeroTimeRange(){return!!this.fullDatasetTimeSpan},calculateActiveMargins(){const e=this.state.componentWidth-2*A,t=Math.floor(e*this.state.leftPosition),i=Math.floor(e*(1-this.state.rightPosition));return{marginLeft:`${t}px`,marginRight:`${i}px`}}},mounted(){this.allTimes.unshift(0),this.range[0]=0,this.getDimensions(),this.setupInitialValues(),this.setupResizer(),window.addEventListener("mouseup",this.dragEnd),window.addEventListener("mousemove",this.dragging)},beforeDestroy(){this.resizer?.disconnect(),window.removeEventListener("mouseup",this.dragEnd),window.removeEventListener("mousemove",this.dragging),this.state.animator&&window.cancelAnimationFrame(this.state.animator)},watch:{"state.currentTime"(){this.updateExtent()},labels(){this.updateLabels()},"state.leftPosition"(){this.emitValues()},"state.rightPosition"(){this.emitValues()}},methods:{updateAnimation(){this.isAnimating=!this.isAnimating,this.isAnimating&&(this.state.animationElapsedTime=this.state.timeFilter[0]-this.range[0],this.state.startTime=Date.now()-this.state.animationElapsedTime/this.ANIMATE_SPEED,this.animate())},findIndexLessThanOrEqualTo(e){let t=0,i=this.allTimes.length-1,a=0;for(;t<=i;){const o=Math.floor((t+i)/2);if(this.allTimes[o]===e)return o;this.allTimes[o]<=e?(a=o,t=o+1):i=o-1}return a},animate(){if(!this.isAnimating)return;this.state.animationElapsedTime=this.ANIMATE_SPEED*(Date.now()-this.state.startTime);const e=this.state.animationElapsedTime+this.range[0];this.state.currentTime=this.findIndexLessThanOrEqualTo(e),e>this.range[1]+this.allTimes[0]&&(this.state.startTime=Date.now(),this.state.animationElapsedTime=0),this.state.timeFilter=[this.allTimes[this.state.currentTime],this.allTimes[this.state.currentTime+1]==null?0:this.allTimes[this.state.currentTime+1]],this.state.animator=window.requestAnimationFrame(this.animate)},setupResizer(){try{this.resizer=new ResizeObserver(this.getDimensions);const e=document.getElementById(`id-${this.id}`);this.resizer.observe(e)}catch(e){console.error(""+e)}},setupInitialValues(){try{this.range&&(this.state.datasetRange=this.range,this.state.timeFilter=[this.allTimes[0],this.allTimes[1]]),this.fullDatasetTimeSpan===0?(this.state.leftPosition=0,this.state.rightPosition=1):this.updateExtent()}catch(e){console.error(""+e)}finally{this.state.isSetupComplete=!0}},updateExtent(){this.state.timeFilter&&(this.state.leftPosition=1/this.fullDatasetTimeSpan*(this.allTimes[this.state.currentTime]-this.allTimes[0]),this.state.rightPosition=1/this.fullDatasetTimeSpan*(this.allTimes[this.state.currentTime+1]==null?this.allTimes[this.state.currentTime]+this.allTimes[0]:this.allTimes[this.state.currentTime+1]-this.allTimes[0]),this.state.timeLabels=[this.convertSecondsToClockTimeMinutes(this.allTimes[this.state.currentTime]),this.convertSecondsToClockTimeMinutes(this.allTimes[this.state.currentTime+1]==null?this.allTimes[this.state.currentTime]+this.allTimes[0]:this.allTimes[this.state.currentTime+1])],this.updateLabels())},updateLabels(){this.state.timeLabels&&(this.state.labels=this.state.timeLabels)},emitValues(){this.state.isSetupComplete&&this.$emit("timeExtent",this.state.timeFilter)},convertSecondsToClockTimeMinutes(e){const t=Math.floor(e/3600),i=Math.floor((e-t*3600)/60),a=e-t*3600-i*60,o={h:`${t}`,m:`${i}`.padStart(2,"0"),s:`${a}`.padStart(2,"0")};return`${o.h}:${o.m}`},getDimensions(){this.state.componentWidth=this.$refs.slider?.clientWidth||0},dragStart(e){this.state.isDragging=!0,this.state.dragStartX=e.clientX;const t=this.state.componentWidth-2*A,i=Math.floor(t*this.state.leftPosition),a=Math.floor(t*(1-this.state.rightPosition)),o=this.state.componentWidth-a-i-2*A;e.offsetX>=0&&e.offsetX<o?this.state.dragType=0:e.offsetX<0?this.state.dragType=1:e.offsetX>o&&(this.state.dragType=2)},dragging(e){if(!this.state.isDragging)return;const t=e.clientX-this.state.dragStartX,i=this.state.componentWidth-2*A;if(this.state.dragType==0){const a=this.extentLeftToRight;let o=(i*this.state.leftPosition+t)/i,m=o+a;o<0&&(o=0,m=a),m>1&&(m=1,o=m-a),this.state.leftPosition=o,this.state.rightPosition=m,this.updateLabels(),this.updateData(),this.state.dragStartX=e.clientX;return}},dragEnd(e){const t=this.findIndexLessThanOrEqualTo(this.state.leftPosition*this.fullDatasetTimeSpan+this.allTimes[0]);this.state.leftPosition=1/this.fullDatasetTimeSpan*(this.allTimes[t]-this.allTimes[0]),this.state.rightPosition=1/this.fullDatasetTimeSpan*(this.allTimes[t+1]==null?this.allTimes[t]+this.allTimes[0]:this.allTimes[t+1]-this.allTimes[0]),this.state.timeFilter=[this.allTimes[t]-this.allTimes[0],this.allTimes[t+1]==null?this.allTimes[t]+this.allTimes[0]:this.allTimes[t+1]-this.allTimes[0]],this.state.isDragging=!1},updateData(){const e=this.findIndexLessThanOrEqualTo(this.state.leftPosition*this.fullDatasetTimeSpan+this.allTimes[0]),t=this.findIndexLessThanOrEqualTo(this.state.leftPosition*this.fullDatasetTimeSpan+this.allTimes[0])+1;this.state.timeLabels=[this.convertSecondsToClockTimeMinutes(this.allTimes[e]),this.convertSecondsToClockTimeMinutes(this.allTimes[t])],this.state.timeFilter=[this.allTimes[e],this.allTimes[t]]}}});var vt=function(){var t=this,i=t._self._c;return t._self._setupProxy,t.hasNonZeroTimeRange?i("div",{staticClass:"time-slider-component",attrs:{id:`id-${t.id}`}},[i("div",{staticClass:"label-area"},[i("p",{staticClass:"p1"},[t._v(t._s(t.state.labels[0]))]),i("p",{directives:[{name:"show",rawName:"v-show",value:t.state.labels[1]!==void 0,expression:"state.labels[1] !== undefined"}],staticClass:"p2"},[t._v(" - "+t._s(t.state.labels[1]))])]),i("div",{staticClass:"slider-area"},[i("button",{staticClass:"button play-button",attrs:{size:"is-small",type:"is-link"},on:{click:t.updateAnimation}},[t._v(t._s(t.isAnimating?"| |":">"))]),i("div",{ref:"slider",staticClass:"time-slider-dragger",on:{mousemove:t.dragging}},[i("div",{staticClass:"active-region",style:t.calculateActiveMargins,on:{mousedown:t.dragStart,mouseup:function(a){return a.stopPropagation(),t.dragEnd.apply(null,arguments)},mousemove:function(a){return a.stopPropagation(),t.dragging.apply(null,arguments)}}})])])]):t._e()},Tt=[],Dt=N(pt,vt,Tt,!1,null,"c898e554");const Ct=Dt.exports;function yt({viewId:e=0,colorRamp:t="Viridis",dark:i=!1,data:a={},negativeValues:o=!1,currentTimeIndex:m=0,mapIsIndependent:h=!1,maxHeight:c=200,cellSize:d=200,opacity:g=.7,upperPercentile:f=100,cbTooltip:p=null}){const[T,v]=H.useState(b.state.viewState);D[e]=r=>{v(r||b.state.viewState)};function l(r){!r||typeof r.latitude!="number"||typeof r.longitude!="number"||(r.center||(r.center=[0,0]),r.center[0]=r.longitude,r.center[1]=r.latitude,v(r),h||b.commit("setMapCamera",r))}function s(r){if(!r?.coordinate)return p&&p(),null;const S=a.mapData[m]?.values;if(!S||!S[r.index])return null;const[z,x]=r.coordinate,C=S[r.index]/a.scaledFactor,y=Number(C.toFixed(6)),k=a.unit,G=Number.isFinite(x)?x.toFixed(4):"",j=Number.isFinite(z)?z.toFixed(4):"",_={html:`<b>${y} ${k}</b><br/>${G} / ${j}`,style:i?{color:"#ccc",backgroundColor:"#2a3c4f"}:{color:"#223",backgroundColor:"white"}};if(p)p(_,r);else return _}const n=$({colormap:t,nshades:10,format:"rba",alpha:1}).map(r=>[r[0],r[1],r[2],255]),u=[new M({id:"gridlayer",data:{length:a.mapData[m].length,attributes:{getPosition:{value:a.mapData[m].centroid,size:2},getFillColor:{value:a.mapData[m].colorData,size:3},getElevation:o?{value:null}:{value:a.mapData[m].values,size:1}}},colorRange:i?n.slice(1):n.reverse().slice(1),coverage:1,autoHighlight:!0,elevationRange:[0,c],elevationScale:c,pickable:!0,opacity:g,cellSize:d,upperPercentile:f,material:!1,transitions:{elevationScale:{type:"interpolation",duration:50}},parameters:{}})];return V.createElement(lt,{layers:u,controller:!0,useDevicePixels:!1,viewState:T,getTooltip:s,onViewStateChange:r=>l(r.viewState)},V.createElement(nt,{mapStyle:b.getters.mapStyle,preventStyleDiffing:!0,mapboxApiAccessToken:B}))}const bt={messages:{en:{loading:"Loading data...",sorting:"Sorting into bins...",aggregate:"Summary",maxHeight:"3D Height",showDetails:"Show Details",selection:"Selection",areas:"Areas",count:"Count"},de:{loading:"Dateien laden...",sorting:"Sortieren...",aggregate:"Daten",maxHeight:"3-D Höhe",showDetails:"Details anzeigen",selection:"Ausgewählt",areas:"Orte",count:"Anzahl"}}},St=F({name:"GridMapPlugin",i18n:bt,components:{BackgroundMapOnTop:K,CollapsiblePanel:tt,DrawingTool:et,GridLayer:yt,ToggleButton:Y.ToggleButton,ZoomButtons:it,TimeSlider:Ct},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean,datamanager:{type:Object}},data(){const e=["Inferno","Magma","Viridis","Greens","Reds","RdYlGn","greenRed"];return{id:`id-${Math.floor(1e12*Math.random())}`,standaloneYAMLconfig:{title:"",description:"",file:"",projection:"",thumbnail:"",cellSize:250,opacity:.7,maxHeight:0,userColorRamp:"Viridis",center:null,zoom:9,mapIsIndependent:!1},colorRamps:e,columnLookup:[],gzipWorker:null,colorRamp:e[0],globalState:b.state,globalMaxValue:Number.POSITIVE_INFINITY,globalMinValue:Number.NEGATIVE_INFINITY,valuesIncludeNeg:!1,tooltip:null,vizDetails:{title:"",description:"",file:"",projection:"",thumbnail:"",cellSize:250,opacity:.7,maxHeight:0,userColorRamp:"virdis",center:null,zoom:9,breakpoints:null,valueColumn:"value",secondValueColumn:"",diff:!1,unit:""},myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},data:null,selectedTimeData:[],allTimePeriodes:[],colors:$({colormap:"Viridis",nshades:10,format:"rba",alpha:1}).map(t=>[t[0],t[1],t[2],255]),currentTime:[0,0],timeToIndex:new Map,guiConfig:{buckets:10,exponent:4,radius:150,opacity:1,height:100,"color ramp":"Viridis",colorRamps:e,flip:!1,steps:10,valueColumn:"",secondValueColumn:"",diff:!1},configId:`gui-config-${Math.floor(1e12*Math.random())}`,guiController:null,minRadius:50,maxRadius:500,radiusStep:5,isLoaded:!1,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",timeRange:[1/0,-1/0],allTimes:[],myDataManager:this.datamanager||new Q(this.root,this.subfolder),availableColumns:[]}},computed:{fileApi(){return new q(this.fileSystem,b)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl},mapProps(){return{viewId:this.id,colorRamp:this.colorRamp,coverage:.65,dark:this.$store.state.isDarkMode,data:this.data,currentTimeIndex:this.timeToIndex.get(this.currentTime[0]),mapIsIndependent:this.vizDetails.mapIsIndependent,maxHeight:this.guiConfig.height,userColorRamp:this.guiConfig["color ramp"],cellSize:this.guiConfig.radius,opacity:this.guiConfig.opacity,upperPercentile:100,cbTooltip:this.cbTooltip}},textColor(){const e={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.$store.state.colorScheme===U.DarkMode?t:e}},watch:{"$store.state.viewState"(){this.vizDetails.mapIsIndependent||D[this.id]&&D[this.id]()}},methods:{cbTooltip(e,t){if(!t){this.tooltip=null;return}e.style.left=`${16+t.devicePixel[0]}px`,e.style.bottom=`${16+t.devicePixel[1]}px`,this.tooltip=e},pickColor(e,t,i,a,o,m){if(m)e=(e-t)*o/(i-t);else if(isNaN(e)||e<0||e>100)return[0,0,0,0];if(this.vizDetails.colorRamp.breakpoints&&this.vizDetails.colorRamp.breakpoints.length==this.vizDetails.colorRamp.fixedColors.length-1){for(let h=0;h<this.vizDetails.colorRamp.breakpoints.length-1;h++)if(e>this.vizDetails.colorRamp.breakpoints[h]&&e<=this.vizDetails.colorRamp.breakpoints[h+1])return E(this.vizDetails.colorRamp.fixedColors[h+1]);return e<this.vizDetails.colorRamp.breakpoints[0]?E(this.vizDetails.colorRamp.fixedColors[0]):e>=this.vizDetails.colorRamp.breakpoints[this.vizDetails.colorRamp.breakpoints.length-1]?E(this.vizDetails.colorRamp.fixedColors[this.vizDetails.colorRamp.fixedColors.length-1]):new Uint8Array([255,255,255,255])}else{const h=Math.floor(e/100*(this.colors.length-1));return this.colors[h]}},async solveProjection(){if(console.log("solveProjection"),!this.thumbnail){console.log("WHAT PROJECTION:");try{const e=await this.fileApi.getFileText(this.myState.subfolder+"/"+this.myState.yamlConfig);this.vizDetails=L.parse(e)}catch(e){console.error(e)}}},async getVizDetails(){if(this.config){this.validateYAML(),this.vizDetails=Object.assign({colorRamp:""},this.config),this.setRadiusAndHeight(),this.setCustomGuiConfig();return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)?await this.loadStandaloneYAMLConfig():this.loadOutputTripsConfig()},loadOutputTripsConfig(){let e="";this.myState.thumbnail||(e=prompt('Enter projection: e.g. "EPSG:31468"')||"EPSG:31468",parseInt(e,10)&&(e="EPSG:"+e)),this.vizDetails={title:"Output Trips",description:this.myState.yamlConfig,file:this.myState.yamlConfig,projection:e,cellSize:this.vizDetails.cellSize,colorRamp:this.vizDetails.colorRamp,opacity:this.vizDetails.opacity,maxHeight:this.vizDetails.maxHeight,userColorRamp:this.vizDetails.userColorRamp,center:this.vizDetails.center,zoom:this.vizDetails.zoom,valueColumn:this.vizDetails.valueColumn,secondValueColumn:this.vizDetails.secondValueColumn,diff:this.vizDetails.diff,unit:this.vizDetails.unit},this.$emit("title",this.vizDetails.title),this.solveProjection()},setRadiusAndHeight(){this.vizDetails.cellSize||I.set(this.vizDetails,"cellSize",250),this.vizDetails.maxHeight||I.set(this.vizDetails,"maxHeight",0),this.vizDetails.opacity||I.set(this.vizDetails,"opacity",.7)},async loadStandaloneYAMLConfig(){try{const e=this.myState.yamlConfig.includes("/")?this.myState.yamlConfig:`${this.myState.subfolder}/${this.myState.yamlConfig}`,t=await this.fileApi.getFileText(e);this.standaloneYAMLconfig=L.parse(t),this.validateYAML(),this.setVizDetails()}catch{const t=`File not found: ${this.myState.subfolder}/${this.myState.yamlConfig}`;this.$emit("error",t)}},validateYAML(){const e=new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig);let t={};e?(console.log("has yaml"),t=this.standaloneYAMLconfig):(console.log("no yaml"),t=this.config),t.cellSize==0&&this.$store.commit("setStatus",{type:w.WARNING,msg:"Radius is out of the recommended range",desc:"Radius can not be zero, preset value used instead. "}),(t.opacity<=0||t.opacity>1)&&this.$store.commit("setStatus",{type:w.WARNING,msg:"Opacity set to zero",desc:"Opacity levels should be between 0 and 1. "}),(t.zoom<5||t.zoom>20)&&this.$store.commit("setStatus",{type:w.WARNING,msg:"Zoom is out of the recommended range ",desc:"Zoom levels should be between 5 and 20. "}),t.maxHeight<0&&this.$store.commit("setStatus",{type:w.WARNING,msg:"maxHeight is out of the recommended range ",desc:"maxHeight should be greater than 0"})},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig),this.setRadiusAndHeight();const e=this.vizDetails.title?this.vizDetails.title:"Grid Map";this.$emit("title",e)},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),i=Z.arrayBufferToBase64(t);i&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${i})`)}catch(e){console.error(e)}},setMapCenter(){if(this.vizDetails.center){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number));const e={longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:10,pitch:0,zoom:this.vizDetails.zoom||10,jump:!0,center:[this.vizDetails.center[0],this.vizDetails.center[1]]};D[this.id]&&D[this.id](e),this.$store.commit("setMapCamera",e);return}},async loadAndPrepareData(){return this.vizDetails.file.indexOf(".avro")>-1?await this.loadAndPrepareAvroData():await this.loadAndPrepareCSVData()},async loadAndPrepareAvroData(){const e=`${this.subfolder}/${this.vizDetails.file}`,t=await this.fileApi.getFileBlob(e),i=await new Promise((l,s)=>{const n=[];X.createBlobDecoder(t).on("metadata",u=>{}).on("data",u=>{n.push(u)}).on("end",()=>{l(n)})});let a=Number.NEGATIVE_INFINITY;const o=i[0];this.allTimes=o.timestamps,this.allTimes=this.allTimes.sort((l,s)=>l-s),this.timeRange[0]=this.allTimes[0],this.timeRange[1]=this.allTimes[this.allTimes.length-1];const m=Object.keys(o.data)[0],h=o.data[m];for(const l of h)a=Math.max(a,l);const c=a>0?100/a:0;this.vizDetails.unit==null&&(this.vizDetails.unit="");const d={mapData:[],scaledFactor:c,unit:this.vizDetails.unit},g=o.xCoords,f=o.yCoords,p=g.length*f.length;o.crs&&(this.vizDetails.projection=o.crs),this.vizDetails.projection||this.$emit("error",'No coordinate projection. Add "projection: EPSG:xxxx" to config');const T=new Float32Array(p*2);let v=0;for(let l=0;l<g.length;l++)for(let s=0;s<f.length;s++){let n=[g[l],f[s]];n=P.toLngLat(this.vizDetails.projection,n),T[v]=n[0],T[v+1]=n[1],v+=2}this.allTimes.forEach((l,s)=>{this.timeToIndex.set(l,s),d.mapData.push({length:p,time:l,centroid:T,values:new Float32Array(p),colorData:new Uint8Array(p*3)})});for(let l=0;l<this.allTimes.length;l++){console.log("time",l);for(let s=0;s<p;s++){const n=l*p+s,u=c*h[n];d.mapData[l].values[s]=u}}return this.myState.statusMessage="",d},async loadAndPrepareCSVData(){this.allTimes=[],this.timeToIndex.clear();const e={dataset:this.vizDetails.file};let t={};try{t=await this.myDataManager.getDataset(e,{subfolder:this.subfolder})}catch(s){this.$emit("error",""+s)}t.comments&&t.comments.length&&t.comments.forEach(s=>{if(s.includes("EPSG")){const n=s.substring(s.lastIndexOf("EPSG")).trim();n&&(this.vizDetails.projection=n)}});let i=this.vizDetails.valueColumn||"";if(!t.allRows[i]){const s=Object.keys(t.allRows).filter(u=>!["x","y","time"].includes(u)),n=s.filter(u=>Array.from(t.allRows[u].values).every(r=>typeof r=="number"));i=(n.length?n[0]:s[0])||"",this.vizDetails.valueColumn=i}const a=t.allRows[this.vizDetails.valueColumn].values;let o;this.vizDetails.diff&&this.vizDetails.secondValueColumn&&(o=t.allRows[this.vizDetails.secondValueColumn].values);const m=t.allRows.time.values;this.availableColumns=Object.keys(t.allRows).filter(s=>!["x","y","time"].includes(s)),this.guiConfig.valueColumn=this.vizDetails.valueColumn,this.guiConfig.secondValueColumn=this.vizDetails.secondValueColumn||"";let h=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(let s=0;s<a.length;s++){if(o){const u=o&&this.vizDetails.diff?a[s]-o[s]:a[s];u<h&&(h=u),u>c&&(c=u),(a[s]||o[s])&&(this.valuesIncludeNeg=!0)}else a[s]>c&&(c=a[s]),a[s]<h&&(h=a[s]),a[s]&&(this.valuesIncludeNeg=!0);const n=m[s];this.allTimes.includes(n)||this.allTimes.push(n)}this.allTimes=this.allTimes.sort((s,n)=>s-n),this.timeRange[0]=Math.min.apply(Math,this.allTimes),this.timeRange[1]=Math.max.apply(Math,this.allTimes);const d=Math.ceil(a.length/this.allTimes.length);let g=h,f=c,p=0,T=100;this.valuesIncludeNeg&&(c=(c-g)*T/(f-g)),this.globalMinValue=g,this.globalMaxValue=f;const v=c!==0?100/c:0,l={mapData:[],scaledFactor:v,unit:this.vizDetails.unit||""};if(this.allTimes.forEach((s,n)=>{this.timeToIndex.set(s,n),l.mapData.push({time:s,values:new Float32Array(d),centroid:new Float32Array(d*2),colorData:new Uint8Array(d*3),numberOfFilledValues:0,numberOfFilledCentroids:0,numberOfFilledColors:0,length:d})}),!this.vizDetails.projection){const s='No coordinate projection. Add "projection: EPSG:xxxx" to config';throw this.$emit("error",s),Error(s)}for(let s=0;s<a.length;s++){const n=this.timeToIndex.get(m[s]);let u=a[s];o&&this.vizDetails.diff&&(u=u-o[s]);const r=v*u,S=this.pickColor(r,g,f,p,T,this.valuesIncludeNeg),z=l.mapData[n].numberOfFilledValues,x=l.mapData[n].numberOfFilledColors,R=l.mapData[n].numberOfFilledCentroids;l.mapData[n].values[z]=r;for(let y=0;y<3;y++)l.mapData[n].colorData[x+y]=S[y];let C=[t.allRows.x.values[s],t.allRows.y.values[s]];this.vizDetails.projection!=="EPSG:4326"&&(C=P.toLngLat(this.vizDetails.projection,C)),l.mapData[n].centroid[R]=C[0],l.mapData[n].centroid[R+1]=C[1],l.mapData[n].numberOfFilledValues=z+1,l.mapData[n].numberOfFilledCentroids=R+2,l.mapData[n].numberOfFilledColors=x+3}return Array.from(this.allTimes.keys()).forEach(s=>{delete l.mapData[s].numberOfFilledValues,delete l.mapData[s].numberOfFilledCentroids,delete l.mapData[s].numberOfFilledColors}),this.myState.statusMessage="",l},resolveProjection(){if(this.vizDetails.projection!=="EPSG:4326")for(let e=0;e<this.data.length;e++){const t=P.toLngLat(this.vizDetails.projection,this.data[e].centroid);this.data[e].centroid=t}},handleTimeSliderValues(e){this.currentTime=e,this.selectedTimeData=[];for(let t=0;t<this.data.length;t++)this.data[t].time==e[0]&&this.selectedTimeData.push(this.data[t])},setupGui(){this.guiController=new W({title:"Settings",injectStyles:!0,width:200,container:document.getElementById(this.configId)||void 0});const e=this.guiController;e.add(this.guiConfig,"radius",this.minRadius,this.maxRadius,this.radiusStep),e.add(this.guiConfig,"opacity",0,1,.1),e.add(this.guiConfig,"height",0,250,5),e.add(this.guiConfig,"diff").name("Diff").onChange(a=>{a?t.show():t.hide(),this.handleDiffChange(a)}),this.availableColumns.length>0&&e.add(this.guiConfig,"valueColumn",this.availableColumns).name("1st column").onChange(a=>{this.handleColumnChange(a)});const t=e.add(this.guiConfig,"secondValueColumn",["",...this.availableColumns]).name("2nd column").onChange(a=>this.handleSecondColumnChange(a));if(this.guiConfig.diff?t.show():t.hide(),this.vizDetails.colorRamp){this.vizDetails.colorRamp.breakpoints&&this.vizDetails.colorRamp.fixedColors&&this.vizDetails.colorRamp.breakpoints.length!==this.vizDetails.colorRamp.fixedColors.length-1&&this.$emit("error","Color ramp breakpoints and fixedColors do not have correct lengths");return}const i=e.addFolder("colors");i.add(this.guiConfig,"color ramp",this.guiConfig.colorRamps).onChange(this.setColors),i.add(this.guiConfig,"flip").onChange(this.setColors),this.setColors()},async handleColumnChange(e){this.vizDetails.valueColumn=e,this.data=await this.loadAndPrepareData(),this.setColors()},async handleDiffChange(e){this.vizDetails.diff=e,this.data=await this.loadAndPrepareData(),this.setColors();const t=this.allTimes[this.allTimes.length-1];this.currentTime=[t,t]},async handleSecondColumnChange(e){this.vizDetails.secondValueColumn=e,this.data=await this.loadAndPrepareData(),this.setColors();const t=this.allTimes[this.allTimes.length-1];this.currentTime=[t,t]},setColors(){if(!this.data)return;const e={ramp:this.guiConfig["color ramp"]},t=J(e,this.guiConfig.steps);if(t.length==0){const h=`Invalid color ramp: ${this.guiConfig["color ramp"]}`;this.$emit("error",h)}t.length&&(this.colors=[]),this.colors=this.hexArrayToRgbArray(t);let i=this.globalMinValue,a=this.globalMaxValue,o=0,m=100;this.guiConfig.flip&&(this.colors=this.colors.reverse());for(let h=0;h<this.data.mapData.length;h++)for(let c=0;c<this.data.mapData[h].values.length;c++){const d=this.data.mapData[h].values[c],g=this.pickColor(d,i,a,o,m,this.valuesIncludeNeg);if(g==null)break;for(let f=c*3;f<=c*3+2;f++)this.data.mapData[h].colorData[f]=g[f%3]}this.currentTime=[...this.currentTime]},hexArrayToRgbArray(e){const t=[];for(let i=0;i<e.length;i++){const a=e[i].replace(/^#/,""),o=parseInt(a.substring(0,2),16),m=parseInt(a.substring(2,4),16),h=parseInt(a.substring(4,6),16);t.push([o,m,h,255])}return t},setCustomGuiConfig(){this.config&&(this.config.colorRamp&&(this.config.colorRamp.ramp!=null&&(this.guiConfig["color ramp"]=this.config.colorRamp.ramp),this.config.colorRamp.reverse!=null&&(this.guiConfig.flip=this.config.colorRamp.reverse),this.config.colorRamp.steps!=null&&(this.guiConfig.steps=this.config.colorRamp.steps)),this.config.cellSize>=this.minRadius&&this.config.cellSize<=this.maxRadius&&(this.guiConfig.radius=this.config.cellSize),this.config.maxHeight!==void 0&&(this.guiConfig.height=this.config.maxHeight),this.config.opacity&&(this.guiConfig.opacity=this.config.opacity),typeof this.config.diff=="boolean"&&(this.guiConfig.diff=this.config.diff,this.vizDetails.diff=this.config.diff),typeof this.config.secondValueColumn=="string"&&(this.guiConfig.secondValueColumn=this.config.secondValueColumn,this.vizDetails.secondValueColumn=this.config.secondValueColumn))}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,await this.getVizDetails(),!this.thumbnail&&(this.myState.statusMessage=`${this.$i18n.t("loading")}`,this.data=await this.loadAndPrepareData(),this.setupGui(),this.setColors(),this.isLoaded=!0,this.setMapCenter())},beforeDestroy(){D[this.id]=void 0,delete D[this.id],this.data=null,this.$store.commit("setFullScreen",!1)}});var zt=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"xy-hexagons",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false",id:`id-${t.id}`}},[!t.thumbnail&&t.isLoaded?i("grid-layer",t._b({attrs:{negativeValues:t.valuesIncludeNeg}},"grid-layer",t.mapProps,!1)):t._e(),t.isLoaded&&t.guiConfig.height==0?i("background-map-on-top"):t._e(),!t.thumbnail&&t.isLoaded?i("zoom-buttons",{attrs:{corner:"top-left"}}):t._e(),i("div",{staticClass:"top-right"},[i("div",{staticClass:"gui-config",attrs:{id:t.configId}})]),t.isLoaded?i("time-slider",{staticClass:"time-slider-area",attrs:{range:t.timeRange,allTimes:t.allTimes},on:{timeExtent:t.handleTimeSliderValues}}):t._e(),!t.thumbnail&&t.myState.statusMessage?i("div",{staticClass:"message"},[i("p",{staticClass:"status-message"},[t._v(t._s(t.myState.statusMessage))])]):t._e(),t.tooltip?i("div",{staticClass:"tooltip",style:t.tooltip.style,domProps:{innerHTML:t._s(t.tooltip.html)}}):t._e()],1)},xt=[],Rt=N(St,zt,xt,!1,null,"66a69ff6");const ae=Rt.exports;export{ae as default};
