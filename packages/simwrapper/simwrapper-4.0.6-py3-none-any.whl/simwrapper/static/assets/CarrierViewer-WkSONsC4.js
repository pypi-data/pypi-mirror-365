import{r as D,g as b,R as O,h,M as Q,d as ee,C as X,n as te}from"./index-SKCiK1zC.js";import{d as se}from"./index-DNDUvpFH.js";import{r as ie}from"./index-DksM12c3.js";import{Y as oe}from"./index-WYdOAFlo.js";import{n as w,H as ne,a as re,p as ae,f as le,g as ce}from"./HTTPFileSystem-BuB8fZgO.js";import{c as he}from"./index-Cy4QFrIo.js";import{P as de,C as pe}from"./LegendColors-f8gUtRYI.js";import{Z as ue}from"./ZoomButtons-Dje-VE6e.js";import{W as me}from"./RoadNetworkLoader.worker-CZuyU4Ze.js";import{D as ge,S as fe}from"./set-rtl-text-plugin-DzNy9J29.js";import{P as ve}from"./PathOffsetLayer-D_6tS9qG.js";import{P as be}from"./path-layer-D9CUlC4w.js";import{A as Y}from"./arc-layer-DzZVa4ri.js";import{T as V,S as z}from"./text-layer-DB5OKgrd.js";import"./fxp-DXsl1rlp.js";import"./layer-extension-Np6Avtxt.js";import"./cut-by-mercator-bounds-BNp6eabq.js";const A={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};function ye(s){const[e,t]=D.useState(b.state.viewState),[i,o]=D.useState({}),[r,p]=D.useState({type:"activity",pickups:[],deliveries:[]}),{dark:y,activeTab:l,numSelectedTours:f,shipments:c,depots:m,legs:k,settings:C,stopActivities:x,center:B,onClick:L,projection:P}=s,{simplifyTours:F,scaleFactor:$,shipmentDotsOnTourMap:H}=C,g=[];O[s.viewId]=()=>{t(b.state.viewState)},D.useEffect(()=>{const n={},a={};c.forEach(d=>{let u=`${d.fromX}-${d.fromY}`;n[u]||(n[u]={type:"pickup",shipmentIds:[],coord:[d.fromX,d.fromY]}),n[u].shipmentIds.push(d.$id),u=`${d.toX}-${d.toY}`,a[u]||(a[u]={type:"delivery",shipmentIds:[],coord:[d.toX,d.toY]}),a[u].shipmentIds.push(d.$id)}),p({type:"activity",pickups:Object.values(n),deliveries:Object.values(a)})},[c]);function R(n){n.object?L(n.object):L(null)}function I(n){t(n),n.center=[n.longitude,n.latitude],b.commit("setMapCamera",n)}function _(n){const{object:a}=n;return a?a?.type=="pickup"?T(n,"pickup"):a?.type=="delivery"?T(n,"delivery"):a?.type=="service"?G(n):a?.color?J(n):a?.type=="depot"?null:Z(n):null}function T(n,a){const{object:d,x:u,y:S}=n;return h.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:u+20,top:S+20}},h.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},h.createElement("tbody",null,h.createElement("tr",null,h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},a,":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},d.shipmentIds.join(", "))))))}function G(n,a){const{object:d,x:u,y:S}=n;return h.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:u+20,top:S+20}},h.createElement("b",null,d?.$id),h.createElement("br",null),h.createElement("h5",{style:{paddingTop:"0.2rem"}},"Capacity Demand: ",d.$capacityDemand))}function J(n){const{object:a,x:d,y:u}=n;return h.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:d+20,top:u-30}},h.createElement("b",null,a?.tour?.vehicleId),h.createElement("br",null),"Leg # ",1+a?.count," ",h.createElement("br",null),"Shipments on board: ",a?.shipmentsOnBoard?.length," ",h.createElement("br",null),"Total size: ",a?.totalSize)}function Z(n){const{object:a,x:d,y:u}=n,S=a.visits.length,j=a.visits.reduce((v,M)=>v+M.pickup.length,0),N=a.visits.reduce((v,M)=>v+M.delivery.length,0),K=j+N,W={visits:S,pickups:j,deliveries:N},U=Object.keys(a).length*20+32;let E=u-30;return E+U>window.innerHeight&&(E=u-U),h.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:d+20,top:E}},h.createElement("table",{style:{fontSize:"0.8rem"}},h.createElement("tbody",null,Object.keys(W).map(v=>h.createElement("tr",{key:v},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},v,":"),h.createElement("td",{style:{fontWeight:"bold"}}," ",W[v]))),K==1&&Object.keys(a.details).map(v=>h.createElement("tr",{key:v},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},v.slice(1),":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},a.details[v]))))))}if(l=="tours"&&(g.push(new be({id:"shipmentLocationDashedLine",data:x,getPath:n=>[n.ptFrom,n.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,getWidth:$/2,widthMinPixels:3,widthMaxPixels:200,rounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new de({dash:!0})]})),F?g.push(new Y({id:"leg-arcs",data:k,getSourcePosition:n=>n.points[0],getTargetPosition:n=>n.points[n.points.length-1],getSourceColor:n=>n.color,getTargetColor:n=>n.color,getWidth:2+($-0)*38/100,getHeight:.5,widthMinPixels:2,widthMaxPixels:40,widthUnits:"pixels",opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[$]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:o})):g.push(new ve({id:"deliveryroutes",data:k,getPath:n=>n.points,getColor:n=>n.color,getWidth:3+($-0)*37/100,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:40,widthUnits:"pixels",rounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:o,parameters:{depthTest:!1},updateTriggers:{getWidth:[$]},transitions:{getWidth:150}})),g.push(new V({id:"dest-labels",data:x,background:!0,backgroundPadding:f!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:n=>{const a=n.visits.reduce((u,S)=>u+S.pickup.length,0),d=n.visits.reduce((u,S)=>u+S.delivery.length,0);return a&&d?[0,0,255]:a?A.pickup:d?A.delivery:[240,130,0]},getPosition:n=>n.midpoint,getText:n=>n.label=="Depot"?n.label:f!==1?" ":`${n.label}`,getSize:n=>n.label=="Depot"?11:f!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:o,visible:H}))),l=="shipments"){g.push(new z({id:"deliveries",data:r.deliveries,getPosition:a=>a.coord,getColor:A.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:o})),g.push(new z({id:"pickups",data:r.pickups,getPosition:a=>a.coord,getColor:A.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:o}));const n=c.length>1?32:255;s.services?g.push(new z({id:"services",data:c,getPosition:a=>[a.toX,a.toY],getColor:[240,0,60,224],getRadius:4,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:o})):g.push(new Y({id:"shipments",data:c,getSourcePosition:a=>[a.fromX,a.fromY],getTargetPosition:a=>[a.toX,a.toY],getSourceColor:[0,228,255,n],getTargetColor:[240,0,60,224],getWidth:1+($-0)*49/100,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthMinPixels:1,widthMaxPixels:50,updateTriggers:{getWidth:[$]},transitions:{getWidth:200}}))}l=="services"&&s.services&&g.push(new z({id:"services",data:c,getPosition:n=>[n.toX,n.toY],getColor:[240,0,60,224],getRadius:4,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:o})),g.push(new V({id:"depots",data:m,background:!0,backgroundPadding:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:[0,150,240],getPosition:n=>n.midpoint,getText:n=>"Depot",getTextAnchor:"middle",getAlignmentBaseline:"center",getSize:11,opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:o}));const q=P&&P!=="Atlantis";return h.createElement(ge,{layers:g,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:R,viewState:e,onViewStateChange:n=>I(n.viewState)},q&&h.createElement(fe,{mapboxApiAccessToken:Q,mapStyle:b.getters.mapStyle}),_(i))}const ke={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"JOBS",tours:"TOURS",pickup:"Pickup",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"AUFTRÃ„GE",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung"}}};w.insensitive=!0;const Se=ee({name:"CarrierPlugin",i18n:ke,components:{LegendColors:pe,ToggleButton:se.ToggleButton,TourViz:ye,ZoomButtons:ue},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,scaleFactor:0},vizDetails:{network:"",carriers:"",projection:"",title:"",description:"",thumbnail:"",services:!1,center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:b.state,isLoaded:!0,showHelp:!1,activeTab:"shipments",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",data:null,carriers:[],vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedCarrier:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},rgb:he({colormap:"phase",nshades:9,format:"rba"}).map(s=>s.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new ne(this.fileSystem,b)},fileSystem(){const s=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(s.length===0)throw console.log("no such project"),Error;return s[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const s={text:"#3498db",bg:"#eeeef480"},e={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?e:s}},watch:{"$store.state.viewState"(){O[this.linkLayerId]&&O[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{handleSelectShipment(s){if(this.selectedShipment===s){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length||this.selectedShipment==null){const e=this.carriers.filter(t=>t.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(e[0])}return}this.shownShipments=this.shipments.filter(e=>e.$id===s.$id),this.selectedShipment=s},processActivitiesInTour(s){const e=[];let t=0;const i={};let o=this.vehicles.filter(c=>c.$id===s.vehicleId)[0];const r=this.links[o.$depotLinkId];let p=[.5*(r[0]+r[2]),.5*(r[1]+r[3])],y=o.$depotLinkId;i[`L${o.$depotLinkId}`]={link:o.$depotLinkId,midpoint:p,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,details:{},ptFrom:[r[0],r[1]],ptTo:[r[2],r[3]]};for(const c of s.plan){if(!c.$shipmentId&&!c.$serviceId)continue;var l;if(c.$serviceId?(e.push(c.$serviceId),l=this.shipmentLookup[c.$serviceId]):(e.push(c.$shipmentId),l=this.shipmentLookup[c.$shipmentId]),!l)continue;const m=c.$type==="pickup"?l.$from:l.$to,k=[this.links[m][0],this.links[m][1]],C=[this.links[m][2],this.links[m][3]],x=[.5*(k[0]+C[0]),.5*(k[1]+C[1])],B=this.$t(c.$type),{from:L,fromX:P,fromY:F,to:$,toX:H,toY:g,id:R,...I}=l,_={id:l.$id,type:B,count:t++,link:m,midpoint:x,label:"",tour:s,details:I,ptFrom:k,ptTo:C};if(m==y)i[`L${m}`].visits[i[`L${m}`].visits.length-1][c.$type].push(_);else if(`L${m}`in i){const T={pickup:[],delivery:[],service:[]};T[c.$type].push(_),i[`L${m}`].visits.push(T)}else{const T={pickup:[],delivery:[],service:[]};T[c.$type].push(_),i[`L${m}`]={link:m,midpoint:x,label:"",tour:s,details:I,ptFrom:k,ptTo:C,visits:[T]}}y=m}const f=Object.values(i);for(let c=0;c<f.length;c++)f[c].label=`${c}`;return f[0].label="Depot",{shipmentIdsInTour:e,stopActivities:f}},setupDepots(){const s={};this.vehicles.forEach(e=>{const t=e.$depotLinkId;let i=this.links[t];i&&(s[t]||(s[t]={type:"depot",link:e.$depotLinkId,midpoint:[.5*(i[0]+i[2]),.5*(i[1]+i[3])],coords:this.links[e.$depotLinkId],vehicles:{}}),s[t].vehicles[e.$id]=e)}),this.depots=Object.values(s),this.shownDepots=this.depots.slice(0)},selectAllTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);for(const s of this.tours){s.legs.forEach((t,i)=>this.addRouteToMap(s,t,i++));const e=this.processActivitiesInTour(s);this.stopActivities=this.stopActivities.concat(e.stopActivities),this.setupDepots()}},async handleSelectTour(s){if(!s.legs.length){console.log("No Route.");for(let o=0;o<s.plan.length;o++)if(s.plan[o].$shipmentId){const r=s.plan[o].$shipmentId,p=[this.shipmentLookup[r].$from,this.shipmentLookup[r].$to];s.legs.push({links:p})}this.vizSettings.simplifyTours=!0}if(this.selectedTours.includes(s)){this.selectedTours=this.selectedTours.filter(o=>o!==s),this.shownLegs=this.shownLegs.filter(o=>o.tour!==s),this.stopActivities=this.stopActivities.filter(o=>o.tour!==s),this.selectedTours.length||this.selectAllTours();return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(s);const{shipmentIdsInTour:e,stopActivities:t}=this.processActivitiesInTour(s);this.shipmentIdsInTour=e;let i=0;for(const o of s.legs)this.addRouteToMap(s,o,i++);this.stopActivities=this.stopActivities.concat(t)},addRouteToMap(s,e,t){const i=[[this.links[e.links[0]][0],this.links[e.links[0]][1]]];for(const o of e.links){const r=i[i.length-1],p=[this.links[o][0],this.links[o][1]];(p[0]!==r[0]||p[1]!==r[1])&&i.push(p),i.push([this.links[o][2],this.links[o][3]])}this.shownLegs=this.shownLegs.concat([{tour:s,shipmentsOnBoard:e.shipmentsOnBoard,totalSize:e.totalSize,count:t,points:i,color:this.rgb[(3+s.tourNumber)%this.rgb.length],type:"leg"}])},handleSelectCarrier(s){if(this.dropdownIsActive=!1,!this.links)return;const e=s.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.tours=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===e){this.selectedCarrier="";return}this.selectedCarrier=e;let t=s.capabilities.vehicles.vehicle||[];this.vehicles=t.sort((i,o)=>w(i,o)),this.setupDepots(),this.shipments=this.processShipments(s),s.services?.service?.length&&(this.services=s.services.service.sort((i,o)=>w(i.$id,o.$id))),this.tours=this.processTours(s),this.shownShipments=this.shipments,this.selectAllTours()},getAllPlans(s){if(s.plan!=null){this.plans.push(s.plan),this.selectedPlan=s.plan;return}if(s.plans!=null){if(s.plans.plan.length==null){this.plans.push(s.plans.plan),this.selectedPlan=s.plans.plan;return}this.plans=s.plans.plan;for(let e=0;e<s.plans.plan.length;e++){if(s.plans.plan[e].selected=="true"){this.selectedPlan=s.plans.plan[e];break}this.selectedPlan=s.plans.plan[e]}}},processTours(s){if(this.getAllPlans(s),!this.selectPlan||!this.plans.length)return[];Array.isArray(this.selectedPlan.tour)||(this.selectedPlan.tour=[this.selectedPlan.tour]);const e=this.selectedPlan.tour.map((t,i)=>{const o=[t.act[0]],r=new Set;for(let l=1;l<t.act.length;l++)t.leg[l-1].shipmentsOnBoard=[...r],o.push(t.leg[l-1]),o.push(t.act[l]),t.act[l].$type=="pickup"&&t.act[l].$shipmentId&&r.add(t.act[l].$shipmentId),t.act[l].$type=="delivery"&&t.act[l].$shipmentId&&r.delete(t.act[l].$shipmentId);const p=t.leg.filter(l=>l.route&&l.route.length).map(l=>{const f=l.shipmentsOnBoard.map(m=>this.shipmentLookup[m]),c=f.reduce((m,k)=>m+parseFloat(k?.$size||0),0);return{shipmentsOnBoard:f,totalSize:c,links:l.route?l.route.split(" "):[]}});return{vehicleId:t.$vehicleId,tourId:t.$tourId,plan:o,legs:p,tourNumber:0}});return e.sort((t,i)=>w(t.vehicleId,i.vehicleId)),e.forEach((t,i)=>t.tourNumber=i),e},processShipments(s){this.shipmentLookup={};var e=[];if(s.shipments?.shipment?.length)e=s.shipments.shipment.sort((t,i)=>w(t.$id,i.$id));else if(s.services?.service?.length)e=s.services.service.sort((t,i)=>w(t.$id,i.$id)),this.processServices(s,e);else return[];try{for(const t of e)t.fromX=.5*(this.links[t.$from][0]+this.links[t.$from][2]),t.fromY=.5*(this.links[t.$from][1]+this.links[t.$from][3]),t.toX=.5*(this.links[t.$to][0]+this.links[t.$to][2]),t.toY=.5*(this.links[t.$to][1]+this.links[t.$to][3]),this.shipmentLookup[t.$id]=t}catch{}return e},processServices(s,e){this.vizDetails.services=!0;try{for(const t of e)t.toX=.5*(this.links[t.$to][0]+this.links[t.$to][2]),t.toY=.5*(this.links[t.$to][1]+this.links[t.$to][3]),t.type="service",this.shipmentLookup[t.$id]=t,console.log(t)}catch{}},buildRouteFromUrl(){const s=this.$route.params;if(!s.project||!s.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const e=1+s.pathMatch.lastIndexOf("/"),t=s.pathMatch.substring(0,e),i=s.pathMatch.substring(e);this.myState.subfolder=t,this.myState.yamlConfig=i},async getVizDetails(){if(this.config){this.vizDetails=Object.assign({},this.config);return}if(this.yamlConfig?.endsWith("yaml")||this.yamlConfig?.endsWith("yml"))try{const o=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,r=await this.fileApi.getFileText(o);this.vizDetails=oe.parse(r),this.vizDetails.title&&this.$emit("title",this.vizDetails.title);return}catch(o){console.log("failed"+o);const r=o;this.fileSystem.needPassword&&r.status===401?b.commit("requestLogin",this.fileSystem.slug):this.$emit("error",""+o);return}const s=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:e}=await this.fileApi.getDirectory(this.myState.subfolder);let t=this.myState.yamlConfig.replaceAll("carriers","network");if(e.indexOf(t)==-1){const o=e.filter(r=>r.indexOf("network")>-1);o.length?t=o[0]:(this.myState.statusMessage="No road network found.",t="")}this.vizDetails={network:t,carriers:this.yamlConfig,title:s,description:"",center:this.vizDetails.center,projection:"",thumbnail:"",services:!1},this.$emit("title","Carrier Explorer"),this.buildThumbnail()},async setMapCenter(){let s=0,e=0,t=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),e=this.vizDetails.center[0],t=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const i=this.data.length/2,o=4096;for(let r=0;r<i;r+=o)e+=this.data[r*2][1][0],t+=this.data[r*2+1][1][1],s++;e=e/s,t=t/s}e&&t&&this.$store.commit("setMapCamera",{longitude:e,latitude:t,zoom:9,bearing:0,pitch:0,jump:!1})},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const s=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),e=await ie.arraybuffer(s),t=re(e);t&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${t})`)}catch(s){console.error(s)}},handleClick(s){console.log("CLICK!",s),s||this.clickedEmptyMap(),s?.type=="depot"&&this.clickedDepot(s),s?.type=="leg"&&this.clickedLeg(s)},clickedDepot(s){const e=Object.values(s.vehicles).map(t=>t.$id);this.selectedTours=[],this.shownShipments=[];for(const t of this.tours)e.includes(t.vehicleId)&&(this.handleSelectTour(t),this.shipmentIdsInTour.forEach(i=>{this.shownShipments.push(this.shipmentLookup[i])}))},clickedLeg(s){s?.tour&&this.handleSelectTour(s?.tour)},clickedEmptyMap(){this.selectAllTours()},updateLegendColors(){},async loadCarriers(){const s=await this.loadFileOrGzippedFile(this.vizDetails.carriers);if(!s)return[];const t=(await ae(s,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((i,o)=>w(i.$id,o.$id));return console.log(t),t},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const s=`${this.myState.subfolder}/${this.vizDetails.network}`,e=await this.fetchNetwork(s,{});this.vizDetails.projection=""+e.projection,this.myState.statusMessage="Building network link table";const t={};return e.linkIds.forEach((i,o)=>{t[i]=[e.source[o*2],e.source[o*2+1],e.dest[o*2],e.dest[o*2+1]]}),t}else{const s=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.network);return this.vizDetails.projection="EPSG:4326",s}},async fetchNetwork(s,e){return new Promise((t,i)=>{const o=new me;try{o.postMessage({filePath:s,fileSystem:this.fileSystem,vizDetails:e}),o.onmessage=r=>{if(r.data.promptUserForCRS){let p=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";Number.isFinite(parseInt(p))&&(p=`EPSG:${p}`),o.postMessage({crs:p});return}if(r.data.status){this.myState.statusMessage=""+r.data.status;return}o.terminate(),r.data.error&&(console.error(r.data.error),b.commit("error",r.data.error),this.myState.statusMessage=r.data.error,i(r.data.error)),t(r.data.links)}}catch(r){o.terminate(),console.error(r),i(r)}})},toggleLoaded(s){this.isLoaded=s},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?X.DarkMode:X.LightMode)},async loadFileOrGzippedFile(s){let e=`${this.subfolder}/${s}`;try{if(e.indexOf("*")>-1||e.indexOf("?")>-1){const o=e.substring(1+e.lastIndexOf("/")),r=e.substring(0,e.lastIndexOf("/")),{files:p}=await this.fileApi.getDirectory(r),y=le(p,o);if(y.length==0)throw Error(`No files matched "${o}"`);if(y.length>1)throw Error(`More than one file matched "${o}": ${y}`);e=`${r}/${y[0]}`}let i="";if(e.endsWith("xml")||e.endsWith("gz")){const r=await(await this.fileApi.getFileBlob(e)).arrayBuffer(),p=await ce(r);return new TextDecoder("utf-8").decode(p)}}catch{}const t=`Error loading ${e}`;return b.commit("error",t),this.myState.statusMessage=t,""},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(s){for(let e=0;e<this.plans.length;e++)this.plans[e].$selected="false";s.$selected="true",this.selectedPlanIndex=this.plans.indexOf(s),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=s}},async mounted(){b.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.carriers.length&&this.handleSelectCarrier(this.carriers[0]),this.tours.length&&this.handleSelectTour(this.tours[0]))},beforeDestroy(){this.myState.isRunning=!1,b.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var $e=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!e.thumbnail},style:{background:e.urlThumbnail},attrs:{oncontextmenu:"return false"}},[t("div",{staticClass:"container-1"},[t("div",{staticClass:"main-panel"},[e.thumbnail?e._e():t("tour-viz",{staticClass:"anim",attrs:{activeTab:e.activeTab,shipments:e.shownShipments,depots:e.shownDepots,legs:e.shownLegs,stopActivities:e.stopActivities,dark:e.globalState.isDarkMode,center:e.vizDetails.center,viewId:e.linkLayerId,settings:e.vizSettings,numSelectedTours:e.selectedTours.length,onClick:e.handleClick,projection:e.vizDetails.projection,services:e.vizDetails.services}}),e.thumbnail?e._e():t("ZoomButtons"),e.myState.statusMessage?t("div",{staticClass:"xmessage"},[e._v(e._s(e.myState.statusMessage))]):e._e()],1),e.thumbnail?e._e():t("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[e.carriers.length?t("h3",{staticStyle:{"margin-left":"0.25rem"}},[e._v(e._s(e.$t("carriers")))]):e._e(),t("div",{staticClass:"carrier-list"},e._l(e.carriers,function(i){return t("div",{key:i.$id,staticClass:"carrier",class:{selected:i.$id===e.selectedCarrier},on:{click:function(o){return e.handleSelectCarrier(i)}}},[t("div",{staticClass:"carrier-title"},[e._v(e._s(i.$id))])])}),0),t("h4",[e._v(e._s(e.selectedCarrier||"Details"))]),e.selectedCarrier?t("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[t("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},model:{value:e.activeTab,callback:function(i){e.activeTab=i},expression:"activeTab"}},[t("span",[e._v(e._s(e.$t("JOBS")))])]),t("b-radio-button",{attrs:{"native-value":"tours",size:"is-small",type:"is-warning"},model:{value:e.activeTab,callback:function(i){e.activeTab=i},expression:"activeTab"}},[t("span",[e._v(e._s(e.$t("tours")))])]),t("b-radio-button",{attrs:{"native-value":"vehicles",size:"is-small",type:"is-warning"},model:{value:e.activeTab,callback:function(i){e.activeTab=i},expression:"activeTab"}},[t("span",[e._v(e._s(e.$t("vehicles")))])]),e.services.length?t("b-radio-button",{attrs:{"native-value":"services",size:"is-small",type:"is-warning"},model:{value:e.activeTab,callback:function(i){e.activeTab=i},expression:"activeTab"}},[t("span",[e._v(e._s(e.$t("services")))])]):e._e()],1):e._e(),t("div",{staticClass:"detail-area"},[e.activeTab=="shipments"&&!e.vizDetails.services?t("div",{staticClass:"shipments"},[t("span",[e._v(e._s(e.$t("JOBS"))+": "+e._s(e.shipments.length))]),e._l(e.shipments,function(i,o){return t("div",{key:`${o}-${i.$id}`,staticClass:"leaf tour",class:{selected:i==e.selectedShipment,"shipment-in-tour":e.shipmentIdsInTour.includes(i.$id)},on:{click:function(r){return e.handleSelectShipment(i)}}},[e._v(e._s(`${i.$id}: ${i.$from}-${i.$to}`))])})],2):e._e(),e.activeTab=="shipments"&&e.vizDetails.services?t("div",{staticClass:"shipments"},[t("span",[e._v(e._s(e.$t("JOBS"))+": "+e._s(e.shipments.length))]),e._l(e.shipments,function(i,o){return t("div",{key:`${o}-${i.$id}`,staticClass:"leaf tour",class:{selected:i==e.selectedShipment,"shipment-in-tour":e.shipmentIdsInTour.includes(i.$id)},on:{click:function(r){return e.handleSelectShipment(i)}}},[e._v(e._s(`${i.$id}`))])})],2):e._e(),e.activeTab=="tours"?t("div",{staticClass:"tours"},[this.plans.length>1?t("div",{staticClass:"dropdown",class:{"is-active":e.dropdownIsActive},staticStyle:{width:"100%"}},[t("div",{staticClass:"dropdown-trigger",on:{click:function(i){return e.selectDropdown()}}},[t("button",[t("span",[e._v("Plan "+e._s(e.selectedPlanIndex+1))]),e._m(0)])]),t("div",{staticClass:"dropdown-menu"},[t("div",{staticClass:"dropdown-content"},e._l(this.plans,function(i,o){return t("a",{staticClass:"dropdown-item",class:{"is-active":i.$selected=="true"},on:{click:function(r){return e.selectPlan(i)}}},[e._v("Plan "+e._s(o+1))])}),0)])]):e._e(),t("span",[e._v(e._s(e.$t("tours"))+": "+e._s(e.tours.length))]),e._l(e.tours,function(i,o){return t("div",{key:`${o}-${i.$id}`,staticClass:"leaf tour",class:{selected:e.selectedTours.includes(i)},on:{click:function(r){return e.handleSelectTour(i)}}},[i.tourId?t("div",[e._v(e._s(i.tourId)+": "+e._s(`${i.vehicleId}`))]):t("div",[e._v(e._s(`${i.vehicleId}`))])])})],2):e._e(),e.activeTab=="vehicles"?t("div",{staticClass:"vehicles"},[t("span",[e._v(e._s(e.$t("vehicles"))+": "+e._s(e.vehicles.length))]),e._l(e.vehicles,function(i,o){return t("div",{key:`${o}-${i.$id}`,staticClass:"leaf tour"},[e._v(e._s(i.$id))])})],2):e._e(),e.activeTab=="services"?t("div",{staticClass:"services"},[t("span",[e._v(e._s(e.$t("services"))+": "+e._s(e.services.length))]),e._l(e.services,function(i,o){return t("div",{key:`${o}-${i.$id}`,staticClass:"leaf tour"},[e._v(e._s(`${i.$id}`))])})],2):e._e()]),t("div",{staticClass:"switchbox"},[t("div",{staticClass:"switches"},[t("p",[e._v(e._s(e.$t("scaleSize")))]),t("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:e.vizSettings.scaleFactor,callback:function(i){e.$set(e.vizSettings,"scaleFactor",i)},expression:"vizSettings.scaleFactor"}})],1),t("div",{staticClass:"switches"},[t("b-switch",{model:{value:e.vizSettings.shipmentDotsOnTourMap,callback:function(i){e.$set(e.vizSettings,"shipmentDotsOnTourMap",i)},expression:"vizSettings.shipmentDotsOnTourMap"}},[t("span",{domProps:{innerHTML:e._s(e.$t("shipmentDots"))}})]),t("b-switch",{model:{value:e.vizSettings.simplifyTours,callback:function(i){e.$set(e.vizSettings,"simplifyTours",i)},expression:"vizSettings.simplifyTours"}},[t("span",{domProps:{innerHTML:e._s(e.$t("flatten"))}})])],1)])],1)])])},Te=[function(){var s=this,e=s._self._c;return s._self._setupProxy,e("span",{staticClass:"icon is-small"},[e("i",{staticClass:"fas fa-angle-down"})])}],we=te(Se,$e,Te,!1,null,"425fe7ac");const Ne=we.exports;export{Ne as default};
