# SPDX-FileCopyrightText: Â© 2025 Josef Hahn
# SPDX-License-Identifier: AGPL-3.0-only
"""
Some internal UI-related utilities.

Not directly used by application developers.
"""
import abc
import contextlib
import gettext
import locale
import pathlib
import typing as t

import klovve.data.list
import klovve.ui.materialization


class MaterializingViewListObserver[TNative](klovve.data.list.List.Observer, abc.ABC):
    """
    Base implementations for list observers that observe lists (often of :py:class:`klovve.ui.View`) in order to
    create a view for each item (unless the items are already views) and materialize and eventually display them
    somehow.
    """

    def __init__(self, get_child_view_native_func: t.Callable[[t.Any], TNative] = None):
        """
        :param get_child_view_native_func: A function that translates a list item to a native view. Optional for lists
                                           of :py:class:`klovve.ui.View`.
        """
        super().__init__()
        self.__get_child_view_native_func = get_child_view_native_func

    @abc.abstractmethod
    def _add_view_native(self, index: int, view_native: TNative) -> None:
        """
        Add a native view.

        :param index: The index to insert it at.
        :param view_native: The native view.
        """

    @abc.abstractmethod
    def _pop_view_native(self, index: int) -> TNative:
        """
        Remove a native view.

        :param index: The index to remove at.
        """

    @abc.abstractmethod
    def _materialize_view(self, view: "klovve.ui.View[TNative]"
                          ) -> "klovve.ui.materialization.ViewMaterialization[klovve.ui.View[TNative], TNative]":
        """
        Materialize a view.

        Only called if no :code:`get_child_view_native_func` was specified during construction.

        :param view: The view to materialize.
        """

    def item_added(self, index, item):
        if self.__get_child_view_native_func is None:
            native = self._materialize_view(item).native
        else:
            native = self.__get_child_view_native_func(item)
        self._add_view_native(index, native)

    def item_removed(self, index, item):
        self._pop_view_native(index)

    def item_moved(self, from_index, to_index, item):
        self._add_view_native(to_index, self._pop_view_native(from_index))


class InternalTranslations:
    """
    Static class with utilities for translations and similar i18n purposes on internal strings.

    This is not used for application's text - they will directly use :code:`gettext` or any other approach - but only
    for texts generated by Klovve itself.
    """

    _custom_translation_dicts = []

    @staticmethod
    def _init():
        for localedir in [None, pathlib.Path(__file__).parent / "_mo"]:
            if gettext.find("klovve", localedir):
                locale.bindtextdomain("klovve", localedir)
                gettext.bindtextdomain("klovve", localedir)
                break

    _init()

    @staticmethod
    def _translate(s: str) -> str:
        for custom_translation_dict in reversed(InternalTranslations._custom_translation_dicts):
            if (answer := custom_translation_dict.get(s)) is not None:
                return answer
        return gettext.dgettext("klovve", s)

    @staticmethod
    @contextlib.contextmanager
    def customized(custom_translation_dict: dict[str, str]):
        InternalTranslations._custom_translation_dicts.append(custom_translation_dict)
        try:
            yield
        finally:
            InternalTranslations._custom_translation_dicts.remove(custom_translation_dict)


def tr(s: str) -> str:
    """
    Return the string by the given identifier, translated to the current user's language.

    :param s: The string identifier.
    """
    return InternalTranslations._translate(s)
